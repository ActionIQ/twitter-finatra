
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Startup Tests &#8212; Finatra 21.5.0 documentation</title>
    <link rel="stylesheet" href="../../_static/flasky.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Test Mixins" href="mixins.html" />
    <link rel="prev" title="Integration Tests" href="integration_tests.html" />
   
  
  <link media="only screen and (max-device-width: 480px)" href="../../_static/small_flask.css" type= "text/css" rel="stylesheet" />
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-39101739-4', 'twitter.github.io');
    ga('send', 'pageview');

  </script>

  </head><body>
  
  

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="mixins.html" title="Test Mixins"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="integration_tests.html" title="Integration Tests"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Finatra</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">User’s Guide</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="startup-tests">
<span id="id1"></span><h1>Startup Tests<a class="headerlink" href="#startup-tests" title="Permalink to this headline">¶</a></h1>
<div class="admonition important">
<p class="first admonition-title">Important</p>
<p class="last">Please see the section on including test-jar dependencies in your project: <a class="reference external" href="../..#test-dependencies">Test Dependencies</a>.</p>
</div>
<p>By default the Finatra embedded testing infrastructure sets the <a class="reference external" href="https://github.com/google/guice">Guice</a>
<a class="reference external" href="https://google.github.io/guice/api-docs/4.0/javadoc/com/google/inject/Stage.html"><cite>com.google.inject.Stage</cite></a> to <cite>DEVELOPMENT</cite> for the object graph of the server or application under
test. For purposes of testing we choose the trade-off of a fast start-up time for the embedded
server at the expense of some runtime performance as classes are lazily loaded when accessed by the
test features.</p>
<p>However, this also means that if you have mis-configured dependencies (e.g., you attempt to inject
a type that the injector cannot construct because it does not have a no-arg constructor nor was it
provided by a module) you may not run into this with regular <a class="reference external" href="feature_tests.html">FeatureTesting</a>
as dependencies are satisfied lazily by default.</p>
<p>As such, we recommend creating a test – a <cite>StartupTest</cite> to check that your service can start
up and report itself as healthy. This is useful for checking the correctness of the object graph,
catching errors that could otherwise cause the server to fail to start.</p>
<div class="section" id="best-practices">
<h2>Best Practices<a class="headerlink" href="#best-practices" title="Permalink to this headline">¶</a></h2>
<p>A <cite>StartupTest</cite> should mimic production as closely as possible.</p>
<ul class="simple">
<li>The <a class="reference external" href="https://google.github.io/guice/api-docs/4.0/javadoc/com/google/inject/Stage.html"><cite>com.google.inject.Stage</cite></a> SHOULD be set to <cite>PRODUCTION</cite> so that all singletons will be
eagerly created at startup (<cite>Stage.DEVELOPMENT</cite> is set by default).</li>
<li>Avoid replacing any bound types (do not use <a class="reference external" href="bind_dsl.html">Explicit Binding with #bind[T]</a> or
<a class="reference external" href="override_modules.html">Override Modules</a>).</li>
<li>Prevent any Finagle clients from making outbound connections during startup by setting the
resolution of clients to <cite>nil</cite>. See: <a class="reference external" href="feature_tests.html#disabling-clients-using-dtabs">Disabling Client using Dtabs</a>.</li>
</ul>
<p>For example:</p>
<div class="code scala highlight-text notranslate"><div class="highlight"><pre><span></span>import com.google.inject.Stage
import com.twitter.finatra.http.EmbeddedHttpServer
import com.twitter.inject.server.FeatureTest
import scala.collection.immutable.ListMap

class MyServiceStartupTest extends FeatureTest {
  val server = new EmbeddedHttpServer(
    stage = Stage.PRODUCTION,
    twitterServer = new SampleApiServer,
    globalFlags = ListMap(com.some.globalFlag.disable -&gt; &quot;true&quot;),
    flags = Map(
      &quot;dtab.add&quot; -&gt; &quot;/$/inet=&gt;/$/nil;/zk=&gt;/$/nil&quot;)
  )

  test(&quot;SampleApiServer#startup&quot;) {
    server.assertHealthy()
  }
}
</pre></div>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">This works for <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/http-server/src/test/scala/com/twitter/finatra/http/EmbeddedHttpServer.scala"><cite>EmbeddedHttpServer</cite></a> or <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/thrift/src/test/scala/com/twitter/finatra/thrift/EmbeddedThriftServer.scala"><cite>EmbeddedThriftServer</cite></a> as well because <code class="docutils literal notranslate"><span class="pre">#assertHealthy()</span></code>
is defined on the <a class="reference external" href="https://github.com/twitter/finatra/blob/c6e4716f082c0c8790d06d9e1664aacbd0c3fede/inject/inject-server/src/test/scala/com/twitter/inject/server/EmbeddedTwitterServer.scala#L264"><cite>EmbeddedTwitterServer</cite></a> super class.</p>
</div>
<p>For examples of how to accomplish this in Java, see <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/examples/http-server/java/src/test/java/com/twitter/finatra/example/HelloWorldServerStartupTest.java"><cite>HelloWorldServerStartupTest</cite></a>.</p>
</div>
<div class="section" id="c-t-server-twitterserver">
<h2><a class="reference external" href="https://github.com/twitter/twitter-server/blob/develop/server/src/main/scala/com/twitter/server/TwitterServer.scala"><cite>c.t.server.TwitterServer</cite></a><a class="headerlink" href="#c-t-server-twitterserver" title="Permalink to this headline">¶</a></h2>
<p>As seen previously, Finatra’s <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/inject/inject-server/src/test/scala/com/twitter/inject/server/FeatureTest.scala"><cite>c.t.inject.server.FeatureTest</cite></a> utility can be used for testing any
extension of <a class="reference external" href="https://github.com/twitter/twitter-server/blob/develop/server/src/main/scala/com/twitter/server/TwitterServer.scala"><cite>c.t.server.TwitterServer</cite></a> – the server under test does not specifically have to
be a server written using the Finatra framework.</p>
<p>Here is an example of writing a StartupTest that starts a <a class="reference external" href="https://github.com/twitter/twitter-server/blob/develop/server/src/main/scala/com/twitter/server/TwitterServer.scala"><cite>c.t.server.TwitterServer</cite></a> and asserts
that it reports itself “healthy”.</p>
<p>Given a simple <a class="reference external" href="https://github.com/twitter/twitter-server/blob/develop/server/src/main/scala/com/twitter/server/TwitterServer.scala"><cite>c.t.server.TwitterServer</cite></a>:</p>
<div class="code scala highlight-text notranslate"><div class="highlight"><pre><span></span>import com.twitter.finagle.{Http, ListeningServer, Service}
import com.twitter.finagle.http.{Status, Response, Request}
import com.twitter.server.TwitterServer
import com.twitter.util.{Await, Future}

class MyTwitterServer extends TwitterServer {
  private[this] val httpPortFlag =
    flag(name = &quot;http.port&quot;, default = &quot;:8888&quot;, help = &quot;External HTTP server port&quot;)

  private[this] def responseString: String = &quot;Hello, world!&quot;
  private[this] val service = Service.mk[Request, Response] { request =&gt;
    val response =
      Response(request.version, Status.Ok)
    response.contentString = responseString
    Future.value(response)
  }

  /** Simple way to expose the bound port once the external listening server is started */
  @volatile private[this] var _httpExternalPort: Option[Int] = None
  def httpExternalPort: Option[Int] = this._httpExternalPort

  def main(): Unit = {
    val server: ListeningServer = Http.server
      .withLabel(&quot;http&quot;)
      .serve(httpPortFlag(), service)
    info(s&quot;Serving on port ${httpPortFlag()}&quot;)
    info(s&quot;Serving admin interface on port ${adminPort()}&quot;)
    onExit {
      Await.result(server.close())
    }
    this._httpExternalPort = Some(server.boundAddress.asInstanceOf[InetSocketAddress].getPort)
    Await.ready(server)
  }
}
</pre></div>
</div>
<p>For examples of how to accomplish this in Java, see <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/examples/injectable-twitter-server/java/src/test/java/com/twitter/finatra/example/ExampleTwitterServerStartupTest.java"><cite>ExampleTwitterServerStartupTest</cite></a>.</p>
<div class="section" id="writing-the-startuptest">
<h3>Writing the StartupTest<a class="headerlink" href="#writing-the-startuptest" title="Permalink to this headline">¶</a></h3>
<p>First, extend the <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/inject/inject-server/src/test/scala/com/twitter/inject/server/FeatureTest.scala"><cite>c.t.inject.server.FeatureTest</cite></a> trait. Then override the <cite>server</cite> definition
with an instance of your <a class="reference external" href="https://github.com/twitter/finatra/blob/c6e4716f082c0c8790d06d9e1664aacbd0c3fede/inject/inject-server/src/test/scala/com/twitter/inject/server/EmbeddedTwitterServer.scala#L264"><cite>EmbeddedTwitterServer</cite></a> which wraps your <a class="reference external" href="https://github.com/twitter/twitter-server/blob/develop/server/src/main/scala/com/twitter/server/TwitterServer.scala"><cite>c.t.server.TwitterServer</cite></a>
under test.</p>
<div class="code scala highlight-text notranslate"><div class="highlight"><pre><span></span>import com.twitter.inject.server.{EmbeddedTwitterServer, FeatureTest, PortUtils}
import scala.collection.immutable.ListMap

class MyTwitterServerFeatureTest extends FeatureTest {

  override protected val server =
    new EmbeddedTwitterServer(
      twitterServer = new MyTwitterServer,
      globalFlags = ListMap(com.some.globalFlag.disable -&gt; &quot;true&quot;),
      flags = Map(
        &quot;http.port&quot; -&gt; PortUtils.ephemeralLoopback,
        &quot;dtab.add&quot; -&gt; &quot;/$/inet=&gt;/$/nil;/zk=&gt;/$/nil&quot;
      )
    )

  test(&quot;MyTwitterServer#starts&quot;) {
    server.isHealthy should be(true)
  }
}
</pre></div>
</div>
<p>It is important to note that for a “non-injectable” TwitterServer, i.e., a direct extension of
<cite>c.t.server.TwitterServer</cite>, the above testing assumes that many of your service startup issues
can be determined at class construction, or in the <cite>init</cite> or <cite>premain</cite>
<a class="reference external" href="../getting-started/lifecycle.html#c-t-server-twitterserver-lifecycle">lifecycle</a> phases.</p>
<p><strong>Why?</strong></p>
<p>By default, the <cite>EmbeddedTwitterServer</cite> will start the underlying server in an different thread,
then <a class="reference external" href="https://github.com/twitter/finatra/blob/416cb3467c88e26704d695c1d6b8176172afa9c4/inject/inject-server/src/test/scala/com/twitter/inject/server/EmbeddedTwitterServer.scala#L692">wait</a>
for the server to <a class="reference external" href="https://github.com/twitter/finatra/blob/416cb3467c88e26704d695c1d6b8176172afa9c4/inject/inject-server/src/test/scala/com/twitter/inject/server/EmbeddedTwitterServer.scala#L684">start</a>
before allowing a test to proceed. However, this differs when the underlying server is a
<cite>c.t.server.TwitterServer</cite> vs. when it is a <cite>c.t.inject.server.TwitterServer</cite>.</p>
<p>For a <cite>c.t.server.TwitterServer</cite> the <cite>EmbeddedTwitterServer</cite> has no hook to determine if a server
has fully started, so relies solely on the <a class="reference external" href="../getting-started/twitter_server.html#http-admin-interface">HTTP Admin Interface</a>
reporting itself as healthy. Note, therefore, if you configure your server to <a class="reference external" href="https://github.com/twitter/twitter-server/blob/696076263178ffb99d4e61d314e49bb8710c74e3/server/src/main/scala/com/twitter/server/AdminHttpServer.scala#L130">disable</a>
the <a class="reference external" href="https://twitter.github.io/twitter-server/Admin.html#admin-interface">TwitterServer HTTP Admin Interface</a>, then you
will not be able to test your server in this manner as the framework will have no way to determine when the server has started.</p>
<p>For a <cite>c.t.inject.server.TwitterServer</cite> the <cite>EmbeddedTwitterServer</cite> is able to wait for the server
to report itself as “started” in the <a class="reference external" href="https://github.com/twitter/finatra/blob/416cb3467c88e26704d695c1d6b8176172afa9c4/inject/inject-app/src/main/scala/com/twitter/inject/app/App.scala#L135">c.t.inject.app.App#main</a>.</p>
<p>Thus, testing your server is healthy for a <cite>c.t.server.TwitterServer</cite> is merely a check against
the <a class="reference external" href="../getting-started/twitter_server.html#http-admin-interface">HTTP Admin Interface</a>
which is started in the <cite>premain</cite> phase.</p>
<div class="admonition caution">
<p class="first admonition-title">Caution</p>
<p>If all of your <cite>c.t.server.TwitterServer</cite> logic is contained in the <cite>main</cite> of your server (like
Finagle client creation, external ListeningServer creation, etc), it is very possible when the
server under test is started in a separate thread, the TwitterServer <cite>HTTP Admin Interface</cite> will
start and report that it is healthy, then the test process will exit before the server under
test in the other thread has gotten to executing its <cite>main</cite> method and thus exiting before
exercising any logic.</p>
<p class="last">In cases like this, you should also ensure to test the logic of your server in regular <a class="reference external" href="feature_tests.html">FeatureTests</a>
and not only assert it is reported as healthy. Again, see the documentation on the
<a class="reference external" href="../getting-started/lifecycle.html">Application and Server Lifecycle</a> for more information.</p>
</div>
</div>
</div>
<div class="section" id="more-information">
<h2>More Information<a class="headerlink" href="#more-information" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><a class="reference internal" href="index.html"><span class="doc">Testing Features</span></a></li>
<li><a class="reference internal" href="embedded.html"><span class="doc">Embedded Servers and Apps</span></a></li>
<li><a class="reference internal" href="feature_tests.html"><span class="doc">Feature Tests</span></a></li>
<li><a class="reference internal" href="integration_tests.html"><span class="doc">Integration Tests</span></a></li>
<li><a class="reference internal" href="mixins.html"><span class="doc">Test Mixins</span></a></li>
<li><a class="reference internal" href="override_modules.html"><span class="doc">Override Modules</span></a></li>
<li><a class="reference internal" href="bind_dsl.html"><span class="doc">Explicit Binding with #bind[T]</span></a></li>
</ul>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/finatra_logo.png" alt="Logo"/>
            </a></p><p>
  <a href="https://github.com/twitter/finatra">Finatra</a> is a Scala services framework built on top of <a href="https://twitter.github.io/twitter-server/">TwitterServer</a> and <a href="https://twitter.github.io/finagle/">Finagle</a>.
</p>

<h3>Useful Links</h3>
<ul>
  <li><a href="https://twitter.github.io/finatra/user-guide">User's&nbsp;Guide</a></li>
  <li><a href="https://finagle.github.io/blog/">Finagle&nbsp;Blog</a></li>
  <li><a href="https://github.com/twitter/finatra">Finatra&nbsp;on&nbsp;Github</a></li>
  <li><a href="https://github.com/twitter/finatra/issues">Github&nbsp;Issues</a></li>
</ul>
  <h3><a href="../../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Startup Tests</a><ul>
<li><a class="reference internal" href="#best-practices">Best Practices</a></li>
<li><a class="reference internal" href="#c-t-server-twitterserver"><cite>c.t.server.TwitterServer</cite></a><ul>
<li><a class="reference internal" href="#writing-the-startuptest">Writing the StartupTest</a></li>
</ul>
</li>
<li><a class="reference internal" href="#more-information">More Information</a></li>
</ul>
</li>
</ul>
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">User’s Guide</a><ul>
      <li>Previous: <a href="integration_tests.html" title="previous chapter">Integration Tests</a></li>
      <li>Next: <a href="mixins.html" title="next chapter">Test Mixins</a></li>
  </ul></li>
  </ul></li>
</ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Search the contents of this site.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
  
    <div class="github-fork-ribbon-wrapper right fixed" style="width: 150px;height: 150px;position: fixed;overflow: hidden;top: 0;z-index: 9999;pointer-events: none;right: 0;"><div class="github-fork-ribbon" style="position: absolute;padding: 2px 0;background-color: #900;background-image: linear-gradient(to bottom, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.15));-webkit-box-shadow: 0 2px 3px 0 rgba(0, 0, 0, 0.5);-moz-box-shadow: 0 2px 3px 0 rgba(0, 0, 0, 0.5);box-shadow: 0 2px 3px 0 rgba(0, 0, 0, 0.5);z-index: 9999;pointer-events: auto;top: 42px;right: -43px;-webkit-transform: rotate(45deg);-moz-transform: rotate(45deg);-ms-transform: rotate(45deg);-o-transform: rotate(45deg);transform: rotate(45deg);"><a target="_blank" href="https://github.com/twitter/finatra" style="font: 700 13px &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;color: #fff;text-decoration: none;text-shadow: 0 -1px rgba(0, 0, 0, 0.5);text-align: center;width: 200px;line-height: 20px;display: inline-block;padding: 2px 0;border-width: 1px 0;border-style: dotted;border-color: rgba(255, 255, 255, 0.7);">Fork me on GitHub</a></div></div>
  

  <div class="footer">
    &copy; Copyright 2013-2021 Twitter, Inc.
    Created using <a href="http://sphinx.pocoo.org/">Sphinx</div>
  
  </body>
</html>