
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>HTTP Streaming &#8212; Finatra 21.4.0 documentation</title>
    <link rel="stylesheet" href="../../_static/flasky.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Message Body Components" href="message_body.html" />
    <link rel="prev" title="HTTP Responses" href="responses.html" />
   
  
  <link media="only screen and (max-device-width: 480px)" href="../../_static/small_flask.css" type= "text/css" rel="stylesheet" />
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-39101739-4', 'twitter.github.io');
    ga('send', 'pageview');

  </script>

  </head><body>
  
  

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="message_body.html" title="Message Body Components"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="responses.html" title="HTTP Responses"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Finatra</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">User’s Guide</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="http-streaming">
<span id="id1"></span><h1>HTTP Streaming<a class="headerlink" href="#http-streaming" title="Permalink to this headline">¶</a></h1>
<p>Finatra supports streaming over HTTP by defining the <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/http-server/src/main/scala/com/twitter/finatra/http/streaming/StreamingRequest.scala">StreamingRequest</a> or a <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/http-server/src/main/scala/com/twitter/finatra/http/streaming/StreamingResponse.scala">StreamingResponse</a> request/response types. A <cite>StreamingRequest</cite>/<cite>StreamingResponse</cite> is an HTTP Request/Response that carries a stream of objects in its body. We support using either of our streaming primitives, <a class="reference external" href="https://github.com/twitter/util/blob/develop/util-core/src/main/scala/com/twitter/io/Reader.scala">Reader</a> or <a class="reference external" href="https://github.com/twitter/util/blob/develop/util-core/src/main/scala/com/twitter/concurrent/AsyncStream.scala">AsyncStream</a>, but we recommend using <cite>Reader</cite> as it has better support for resource management.</p>
<div class="section" id="features">
<h2>Features<a class="headerlink" href="#features" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>The ability to program in terms of streams of domain objects instead of bytes. For example:<ul>
<li>A <cite>StreamingRequest</cite> will deserialize a valid JSON string to a domain object using the <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/jackson/src/main/scala/com/twitter/finatra/json/internal/streaming/JsonStreamParser.scala">JsonStreamParser</a>.</li>
<li>A <cite>StreamingResponse</cite> will convert a domain object to a JSON string using the <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/jackson/src/main/scala/com/twitter/finatra/jackson/ScalaObjectMapper.scala">ScalaObjectMapper</a>.</li>
</ul>
</li>
<li>The ability to bypass the <cite>ObjectMappper</cite> and <cite>JsonStreamParser</cite> by dealing with streams of <cite>Buf</cite> directly.</li>
<li>The ability to perform resource management by using the signal from <cite>Reader#onClose</cite>.</li>
<li>The ability to perform composable operations over streams using <cite>map</cite> and <cite>flatMap</cite>.</li>
<li>Built-in <a class="reference external" href="https://docbird.twitter.biz/finagle/Metrics.html#streaming">streaming metrics</a> to gain more insights into a streams’ health.</li>
</ul>
</div>
<div class="section" id="examples">
<h2>Examples<a class="headerlink" href="#examples" title="Permalink to this headline">¶</a></h2>
<p>Finatra streaming support lets controllers stream input, output, or both. By recognizing the input and output signatures of a handler as either a <cite>Reader</cite>, <cite>StreamingRequest</cite>, or <cite>StreamingResponse</cite>, Finatra will make the necessary conversions.</p>
<p><cite>StreamingRequest</cite> and <cite>StreamingResponse</cite> are fully featured Request/Response objects and allow you control over, and access to, request parameters and headers. If instead, you only need to consume or return data without having to inspect the request or modify the response, you can deal completely in terms of our streaming primitives.</p>
<div class="code scala highlight-text notranslate"><div class="highlight"><pre><span></span>import com.twitter.finatra.http.Controller
import com.twitter.finatra.http.streaming.StreamingRequest
import com.twitter.io.{Buf, Reader}

case class Tweet(text: String)

class MyTweetController extends Controller {

  // StreamingRequest[Reader, Tweet] =&gt; StreamingResponse[Reader, String]
  post(&quot;/tweets/streaming/request/response&quot;) { streamingRequest: StreamingRequest[Reader, Tweet] =&gt;
    // In this case we need to look at a specific header
    val specialHeader: String = streamingRequest.request.headerMap(&quot;Special-Header&quot;)
    // Grab the input stream and do some work with it
    val responseReader: Reader[String] = streamingRequest.stream.map(_.text + specialHeader)
    // create a `StreamingResponse` via `ResponseBuilder` with our special header
    response.streaming(responseReader, headers = Map(&quot;Special-Header&quot; -&gt; Seq(&quot;Thank you!&quot;)))
  }

  // Reader[Tweet] =&gt; StreamingResponse[Reader, String]
  post(&quot;/tweets/streaming/reader/response&quot;) { tweetReader: Reader[Tweet] =&gt;
    // Grab the input stream and do some work with it
    val responseReader: Reader[String] = tweetReader.map(_.text)
    // create a `StreamingResponse` via `ResponseBuilder` with our special header
    response.streaming(responseReader, headers = Map(&quot;Special-Header&quot; -&gt; Seq(&quot;Thank you!&quot;)))
  }

  // Reader[Tweet] =&gt; Reader[String]
  post(&quot;/tweets/streaming/reader/reader&quot;) { tweetReader: Reader[Tweet] =&gt;
    // Grab the tweets, do some work with them and return the result
    tweetReader.map(_.text)
  }

  // Reader[Buf] =&gt; Reader[Buf]
  post(&quot;/tweets/streaming/reader/reader/bytes&quot;) { byteReader: Reader[Buf] =&gt;
    // Grab the raw bytes, do some work with them and return the result
    byteReader.map(bytes =&gt; Buf.Utf8(bytes.toString + &quot;hi&quot;))
  }

}
</pre></div>
</div>
<p>Resource management is performed by listening to <cite>Reader#onClose</cite>.</p>
<div class="code scala highlight-text notranslate"><div class="highlight"><pre><span></span>import com.twitter.finatra.http.streaming.StreamingRequest
import com.twitter.io.Reader
import com.twitter.util.Closable

trait Resource extends Closable {
  def lookup(test: String): String
}

class MyOtherTweetController extends Controller {
  def closableResource(): Resource = ???

  post(&quot;/tweets/streaming/reader_with_resource_management&quot;) {
    streamingRequest: StreamingRequest[Reader, Tweet] =&gt;
      val resource = closableResource()

      // create a `Reader` with any object types to pass to the `StreamingResponse`
      val responseReader: Reader[String] = streamingRequest.stream.map(
        tweet =&gt; resource.lookup(tweet.text)
      )

      // close the resource after `reader#onClose` is resolved
      responseReader.onClose.ensure(resource.close())

      // create a `StreamingResponse` via `ResponseBuilder`
      response.streaming(responseReader)
  }
}
</pre></div>
</div>
<p>You can check out more streaming examples from <a class="reference external" href="https://github.com/twitter/finatra/tree/develop/examples/advanced/streaming-example">Finatra examples</a>.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/finatra_logo.png" alt="Logo"/>
            </a></p><p>
  <a href="https://github.com/twitter/finatra">Finatra</a> is a Scala services framework built on top of <a href="https://twitter.github.io/twitter-server/">TwitterServer</a> and <a href="https://twitter.github.io/finagle/">Finagle</a>.
</p>

<h3>Useful Links</h3>
<ul>
  <li><a href="https://twitter.github.io/finatra/user-guide">User's&nbsp;Guide</a></li>
  <li><a href="https://finagle.github.io/blog/">Finagle&nbsp;Blog</a></li>
  <li><a href="https://github.com/twitter/finatra">Finatra&nbsp;on&nbsp;Github</a></li>
  <li><a href="https://github.com/twitter/finatra/issues">Github&nbsp;Issues</a></li>
</ul>
  <h3><a href="../../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">HTTP Streaming</a><ul>
<li><a class="reference internal" href="#features">Features</a></li>
<li><a class="reference internal" href="#examples">Examples</a></li>
</ul>
</li>
</ul>
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">User’s Guide</a><ul>
      <li>Previous: <a href="responses.html" title="previous chapter">HTTP Responses</a></li>
      <li>Next: <a href="message_body.html" title="next chapter">Message Body Components</a></li>
  </ul></li>
  </ul></li>
</ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Search the contents of this site.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
  
    <div class="github-fork-ribbon-wrapper right fixed" style="width: 150px;height: 150px;position: fixed;overflow: hidden;top: 0;z-index: 9999;pointer-events: none;right: 0;"><div class="github-fork-ribbon" style="position: absolute;padding: 2px 0;background-color: #900;background-image: linear-gradient(to bottom, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.15));-webkit-box-shadow: 0 2px 3px 0 rgba(0, 0, 0, 0.5);-moz-box-shadow: 0 2px 3px 0 rgba(0, 0, 0, 0.5);box-shadow: 0 2px 3px 0 rgba(0, 0, 0, 0.5);z-index: 9999;pointer-events: auto;top: 42px;right: -43px;-webkit-transform: rotate(45deg);-moz-transform: rotate(45deg);-ms-transform: rotate(45deg);-o-transform: rotate(45deg);transform: rotate(45deg);"><a target="_blank" href="https://github.com/twitter/finatra" style="font: 700 13px &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;color: #fff;text-decoration: none;text-shadow: 0 -1px rgba(0, 0, 0, 0.5);text-align: center;width: 200px;line-height: 20px;display: inline-block;padding: 2px 0;border-width: 1px 0;border-style: dotted;border-color: rgba(255, 255, 255, 0.7);">Fork me on GitHub</a></div></div>
  

  <div class="footer">
    &copy; Copyright 2013-2021 Twitter, Inc.
    Created using <a href="http://sphinx.pocoo.org/">Sphinx</div>
  
  </body>
</html>