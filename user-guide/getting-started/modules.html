
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Modules &#8212; Finatra 22.2.0 documentation</title>
    <link rel="stylesheet" href="../../_static/flasky.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Binding Annotations" href="binding_annotations.html" />
    <link rel="prev" title="Application and Server Lifecycle" href="lifecycle.html" />
   
  
  <link media="only screen and (max-device-width: 480px)" href="../../_static/small_flask.css" type= "text/css" rel="stylesheet" />
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-39101739-4', 'twitter.github.io');
    ga('send', 'pageview');

  </script>

  </head><body>
  
  

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="binding_annotations.html" title="Binding Annotations"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="lifecycle.html" title="Application and Server Lifecycle"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Finatra</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">User’s Guide</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="modules">
<span id="id1"></span><h1>Modules<a class="headerlink" href="#modules" title="Permalink to this headline">¶</a></h1>
<p>Modules are used in conjunction with dependency injection to specify <em>how</em> to instantiate an instance
of a given type. They are especially useful when instantiation of an instance is dependent on some
type of external configuration (see: <a class="reference external" href="flags.html">Flags</a>).</p>
<div class="section" id="c-t-inject-twittermodule">
<h2><a class="reference external" href="https://github.com/twitter/finatra/blob/develop/inject/inject-core/src/main/scala/com/twitter/inject/TwitterModule.scala">c.t.inject.TwitterModule</a><a class="headerlink" href="#c-t-inject-twittermodule" title="Permalink to this headline">¶</a></h2>
<p>We provide the <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/inject/inject-core/src/main/scala/com/twitter/inject/TwitterModule.scala">c.t.inject.TwitterModule</a>
base class which extends the capabilities of the excellent Scala extensions for Google
<a class="reference external" href="https://github.com/google/guice">Guice</a> provided by <a class="reference external" href="https://github.com/codingwell/scala-guice">codingwell/scala-guice</a>.</p>
<div class="admonition-best-practices admonition">
<p class="first admonition-title">Best Practices</p>
<p class="last">See the <a class="reference external" href="#best-practices">Best Practices</a> section for general guidelines on working with Modules in Finatra.</p>
</div>
</div>
<div class="section" id="differences-with-google-guice-modules">
<h2>Differences with Google Guice <a class="reference external" href="https://github.com/google/guice/wiki/GettingStarted#guice-modules">Modules</a><a class="headerlink" href="#differences-with-google-guice-modules" title="Permalink to this headline">¶</a></h2>
<p>The <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/inject/inject-core/src/main/scala/com/twitter/inject/TwitterModule.scala">c.t.inject.TwitterModule</a>
differs from the regular Google Guice <a class="reference external" href="https://github.com/google/guice/wiki/GettingStarted#guice-modules">Module</a>
in two important ways:</p>
<ul class="simple">
<li><strong>It layers in the application lifecycle</strong>. That is, a <cite>TwitterModule</cite> has <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/inject/inject-core/src/main/scala/com/twitter/inject/TwitterModuleLifecycle.scala">lifecycle functions</a>
which are exposed to users in order to tie Module behavior to the application <a class="reference external" href="lifecycle.html">lifecycle</a>.</li>
<li><strong>Integration with</strong> <a class="reference external" href="flags.html">Flags</a>.</li>
</ul>
<p>These differences are why it is <strong>strongly</strong> encouraged that users <strong>do not</strong> manually install
<cite>TwitterModules</cite>. That is, <strong>do not</strong> use <a class="reference external" href="https://google.github.io/guice/api-docs/4.2/javadoc/com/google/inject/Binder.html#install-com.google.inject.Module-">Binder#install</a>
inside of <cite>Module#configure()</cite>.</p>
<div class="code scala highlight-text notranslate"><div class="highlight"><pre><span></span>import com.google.inject.{AbstractModule, Provides}
import com.twitter.inject.TwitterModule
import com.twitter.inject.annotations.Flag
import javax.inject.Singleton

object MyModule1 extends TwitterModule {
  flag(
    name = &quot;some.flag&quot;,
    default = &quot;defaultOfSomeFlag&quot;,
    help = &quot;The value of a flag to use.&quot;
  )

  @Singleton
  @Provides
  def providesFooInstance(
    @Flag(&quot;some.flag&quot;) someFlag: String,
    @Flag(&quot;client.label&quot;) label: String
  ): Foo = new Foo(someFlag)
}

...

object MyModule2 extends TwitterModule {
  override def configure(): Unit = {
    bind[Bar].toInstance(new Bar())
    install(MyModule1) // DO NOT DO THIS
  }
}

class MyModule2 extends AbstractModule {
  override def configure(): Unit = {
    install(MyModule1) // NOR THIS
  }
}
</pre></div>
</div>
<p>Installing a <cite>TwitterModule</cite> this way will cause <a class="reference external" href="#module-lifecycle">lifecycle functions</a> as well
as Flag parsing of <a class="reference external" href="flag.html">Flag</a> instances defined within the installed <cite>TwitterModule</cite> to be
skipped. In cases where your <cite>TwitterModule</cite> <em>only</em> does instance binding, installing a <cite>TwitterModule</cite>
can work but it is <strong>strongly recommended to follow the guidelines</strong> on how to <a class="reference external" href="#module-configuration-in-servers">add</a>
a <cite>TwitterModule</cite> to your application or how to have one <cite>TwitterModule</cite> <a class="reference external" href="#modules-depending-on-other-modules">depend</a>
on another <cite>TwitterModule</cite> (which is akin to installing a Module inside the <cite>configure()</cite> of another
Module like above).</p>
<div class="admonition important">
<p class="first admonition-title">Important</p>
<p class="last">Reminder: It is important that the framework install all <cite>TwitterModules</cite> such that the <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/inject/inject-core/src/main/scala/com/twitter/inject/TwitterModuleLifecycle.scala">lifecycle functions</a>
are executed in the proper sequence and any <cite>TwitterModule</cite> defined <a class="reference external" href="flags.html">Flags</a> are
parsed properly.</p>
</div>
<p>More information on defining <cite>Flags</cite> within a <cite>TwitterModule</cite> and the <cite>TwitterModule</cite> lifecycle below.</p>
</div>
<div class="section" id="defining-modules">
<h2>Defining Modules<a class="headerlink" href="#defining-modules" title="Permalink to this headline">¶</a></h2>
<p>Generally, Modules are for helping the Injector instantiate classes that you don’t control.
Otherwise, you would simply add the <a class="reference external" href="https://github.com/google/guice/wiki/JSR330">JSR-330</a>
annotations (e.g., <code class="docutils literal notranslate"><span class="pre">&#64;Inject</span></code>, <code class="docutils literal notranslate"><span class="pre">&#64;Singleton</span></code>) directly to the class definition.</p>
<p>For example, if we wanted to declare an HTTP <a class="reference external" href="https://twitter.github.io/finagle/guide/Clients.html">Finagle Client</a>
of type <cite>Service[Request, Response]</cite> as a constructor-arg to a <cite>MyService</cite> class:</p>
<div class="code scala highlight-text notranslate"><div class="highlight"><pre><span></span>import com.twitter.finagle.Service
import com.twitter.finagle.http.{Request, Response}
import javax.inject.Inject

class MyService @Inject() (
  httpClient: Service[Request, Response]) {
  ???
}
</pre></div>
</div>
<p>Adding the <code class="docutils literal notranslate"><span class="pre">&#64;Inject</span></code> documents that the <cite>MyService</cite> class participates in dependency injection.
Note that the <code class="docutils literal notranslate"><span class="pre">&#64;Inject</span></code> annotation can be considered “metadata”. Nothing prevents you from
instantiating <cite>MyService</cite> manually and passing it a <cite>Service[Request, Response]</cite> instance.</p>
<div class="code scala highlight-text notranslate"><div class="highlight"><pre><span></span>val httpClient: Service[Request, Response] = ???

val svc: MyService = new MyService(httpClient)
</pre></div>
</div>
<p>However, when an instance of <cite>MyService</cite> is requested to be provided by the Injector, the Injector
will attempt to provide all constructor arguments from the object graph – instantiating classes as
necessary.</p>
<div class="code scala highlight-text notranslate"><div class="highlight"><pre><span></span>val svc: MyService = injector.instance[MyService]

// or

class MyFoo @Inject()(svc: MyService) {
  ???
}
</pre></div>
</div>
<p>The Injector will look for public no-arg constructors. If the Injector cannot find
a public no-arg constructor, it attempts to find a <cite>Provider</cite> of the instance. In this case,
<cite>c.t.finagle.Service</cite> <em>does not</em> have a public no-arg constructor so the Injector needs help to
satisfy the <cite>MyService</cite> constructor (for more information on constructor injection see the Guice
<a class="reference external" href="https://github.com/google/guice/wiki/Injections#constructor-injection">documentation</a>).</p>
<p>To help the Injector, we can create a Module which defines a provider of this
type to the object graph for the Injector to use.</p>
<div class="code scala highlight-text notranslate"><div class="highlight"><pre><span></span>import com.google.inject.Provides
import com.twitter.finagle.Service
import com.twitter.finagle.http.{Request, Response}
import com.twitter.inject.TwitterModule
import com.twitter.inject.annotations.Flag
import javax.inject.Singleton

object MyModule1 extends TwitterModule {
  flag(
    name = &quot;client.dest&quot;,
    default = &quot;defaultDestIfNoneProvided&quot;,
    help = &quot;The client dest to use.&quot;
  )
  flag(
    name = &quot;client.label&quot;,
    default = &quot;defaultLabelIfNoneProvided&quot;,
    help = &quot;The client label to use.&quot;
  )

  @Singleton
  @Provides
  def providesHttpClient(
    @Flag(&quot;client.dest&quot;) dest: String,
    @Flag(&quot;client.label&quot;) label: String
  ): Service[Request, Response] =
    Http.newClient(dest = dest, label = label)
}
</pre></div>
</div>
<p>or in Java:</p>
<div class="code java highlight-text notranslate"><div class="highlight"><pre><span></span>import com.google.inject.Provides;
import com.twitter.finagle.Service;
import com.twitter.finagle.http.Request;
import com.twitter.finagle.http.Response;
import com.twitter.inject.TwitterModule;
import com.twitter.inject.annotations.Flag;
import javax.inject.Singleton;

public class MyModule1 extends TwitterModule {

  public MyModule1() {
    createFlag(
      /* name      = */ &quot;client.dest&quot;,
      /* default   = */ &quot;defaultDestIfNoneProvided&quot;,
      /* help      = */ &quot;The client dest to use.&quot;,
      /* flaggable = */ Flaggable.ofString()
    );

    createFlag(
      /* name      = */ &quot;client.label&quot;,
      /* default   = */ &quot;defaultLabelIfNoneProvided&quot;,
      /* help      = */ &quot;The client label to use.&quot;,
      /* flaggable = */ Flaggable.ofString()
    );
  }

  @Singleton
  @Provides
  public Service&lt;Request, Response&gt; providesHttpClient(
    @Flag(&quot;client.dest&quot;) String dest,
    @Flag(&quot;client.label&quot;) String label) {
    return Http.newClient(dest, label);
  }
}
</pre></div>
</div>
<p>Here we define a Module to construct a Singleton <a class="reference external" href="https://twitter.github.io/finagle/guide/Clients.html">Finagle Client</a>
of type <cite>Service[Request, Response]</cite> which uses <a class="reference external" href="flags.html#passing-flag-values-as-command-line-arguments">parsed Flag values provided through command line arguments</a>
for the values of <cite>label</cite> and <cite>dest</cite>.</p>
<div class="section" id="provides">
<h3><code class="docutils literal notranslate"><span class="pre">&#64;Provides</span></code><a class="headerlink" href="#provides" title="Permalink to this headline">¶</a></h3>
<p>The instance is provided by a Module method annotated with <code class="docutils literal notranslate"><span class="pre">&#64;Provides</span></code>
(<a class="reference external" href="https://github.com/google/guice/blob/master/core/src/com/google/inject/Provides.java">source</a>)
which serves as a provider of the type to the object graph.</p>
<p>Thus, we have now provided a way for the Injector to construct an instance of type
<cite>Service[Request, Response]</cite> allowing the Injector to satisfy construction of <cite>MyService</cite> when the
<cite>MyModule1</cite> is added to the server’s list of Modules.</p>
<div class="code scala highlight-text notranslate"><div class="highlight"><pre><span></span>val svc: MyService = injector.instance[MyService]
</pre></div>
</div>
<p>Note: if your Module method annotated with <code class="docutils literal notranslate"><span class="pre">&#64;Provides</span></code> has an argument list, all arguments to the
method are provided by the Injector (since it is the Injector calling the method in the first place).</p>
<p>Much like an <code class="docutils literal notranslate"><span class="pre">&#64;Inject</span></code> annotated constructor, the Injector will attempt to provide all of the method
arguments from the object graph – instantiating classes as necessary.</p>
<p>For example:</p>
<div class="code scala highlight-text notranslate"><div class="highlight"><pre><span></span> import com.google.inject.Provides
 import com.twitter.inject.TwitterModule
 import javax.inject.Singleton

 object MyModule1 extends TwitterModule {

   @Singleton
   @Provides
   def providesBar(foo: Foo): Bar = {
     new Bar(foo)
   }
}
</pre></div>
</div>
<p>or in Java:</p>
<div class="code java highlight-text notranslate"><div class="highlight"><pre><span></span> import com.google.inject.Provides;
 import com.twitter.inject.TwitterModule;
 import javax.inject.Singleton;

 public final class MyModule1 extends TwitterModule {

   @Singleton
   @Provides
   public Bar providesBar(Foo foo) {
     return new Bar(foo);
   }
}
</pre></div>
</div>
<p>The argument <cite>foo: Foo</cite> will be “injected” in the sense that the Injector will attempt to provide
an instance of <cite>foo</cite> when invoking the method.</p>
<p>See <a class="reference external" href="#module-configuration-in-servers">Module Configuration in Servers</a>.</p>
</div>
<div class="section" id="flags-in-modules">
<h3>Flags in Modules<a class="headerlink" href="#flags-in-modules" title="Permalink to this headline">¶</a></h3>
<p>As seen in the example above, <a class="reference external" href="https://github.com/twitter/util/blob/develop/util-app/src/main/scala/com/twitter/app/Flag.scala">TwitterUtil Flags</a>
can be defined inside Modules. This allows for re-usable scoping of external configuration that can
be composed into a server via the Module. See the documentation on <a class="reference external" href="flags.html">Flags</a> for more
information.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">In Java, Flag creation is implemented with two explicit methods: <a class="reference external" href="https://github.com/twitter/finatra/blob/9a1380eb6527ef9e3d7f6cc0f7ced620217cdca0/inject/inject-core/src/main/scala/com/twitter/inject/TwitterModuleFlags.scala#L26">createFlag&lt;T&gt;</a>
and <a class="reference external" href="https://github.com/twitter/finatra/blob/9a1380eb6527ef9e3d7f6cc0f7ced620217cdca0/inject/inject-core/src/main/scala/com/twitter/inject/TwitterModuleFlags.scala#L44">createMandatoryFlag&lt;T&gt;</a>.
Where “mandatory” means a Flag defined with no default value and thus a command line value is
required, or “mandatory” in order to use the Flag.</p>
</div>
</div>
</div>
<div class="section" id="module-configuration-in-servers">
<h2>Module Configuration in Servers<a class="headerlink" href="#module-configuration-in-servers" title="Permalink to this headline">¶</a></h2>
<p>A server can be configured with a list of Modules:</p>
<div class="code scala highlight-text notranslate"><div class="highlight"><pre><span></span>import com.google.inject.Module
import com.twitter.finatra.http.HttpServer

class Server extends HttpServer {

  override val modules: Seq[Module] = Seq(
    MyModule1,
    MyModule2,
    ClientIdModule,
    ClientAModule,
    ClientBModule)

  ???
}
</pre></div>
</div>
<p>and in Java:</p>
<div class="code java highlight-text notranslate"><div class="highlight"><pre><span></span>import com.google.inject.Module;
import com.twitter.finatra.http.AbstractHttpServer;
import java.util.Arrays;
import java.util.Collection;
import java.util.Collections;

public class Server extends AbstractHttpServer {

  @Override
  public Collection&lt;Module&gt; javaModules() {
    return Collections.unmodifiableList(
        Arrays.asList(
          MyModule1$.MODULE$,
          MyModule2$.MODULE$,
          ClientIdModule$.MODULE$,
          ClientAModule$.MODULE$,
          ClientBModule$.MODULE$));
  }

  ...
}
</pre></div>
</div>
<p>How explicit to be in listing the Modules for your server is up to you. If you include a Module that
is already <a class="reference external" href="modules.html#modules-depending-on-other-modules">included by another Module</a>,
Finatra will de-duplicate the Module list so there is no penalty, but you may want to prefer to define
your list of Modules as <a class="reference external" href="https://en.wikipedia.org/wiki/Don%27t_repeat_yourself">DRY</a> as possible.</p>
<p>Much like declaring dependencies, we recommend that you be explicit in listing all the
Modules that provide bindings used directly by your code.</p>
<p>For more information on server configuration see the <a class="reference external" href="../http/server.html">HTTP</a> or
<a class="reference external" href="../thrift/server.html">Thrift</a> sections.</p>
</div>
<div class="section" id="module-lifecycle">
<h2>Module Lifecycle<a class="headerlink" href="#module-lifecycle" title="Permalink to this headline">¶</a></h2>
<p>Modules can hook into the Server lifecycle through the <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/inject/inject-core/src/main/scala/com/twitter/inject/TwitterModuleLifecycle.scala">c.t.inject.TwitterModuleLifecycle</a>
which allows for a Module to specify startup and shutdown functionality that is re-usable and scoped
to the context of the Module.</p>
<p>If your Module provides a resource that requires one-time start-up or initialization you can do this
by implementing the <cite>singletonStartup</cite> method in your TwitterModule. Conversely, if you want to
clean up resources on graceful shutdown of the server you can implement the <cite>singletonShutdown</cite>
method of your TwitterModule to close or shutdown any resources provided by the Module. Thus, you
are able to bind closable resources with a defined way to release them. This allows users to overcome
some of the limitations of a standard <a class="reference external" href="https://google.github.io/guice/api-docs/latest/javadoc/index.html?com/google/inject/AbstractModule.html">com.google.inject.AbstractModule</a>.</p>
<p>Additionally, there is also the <cite>TwitterModule#singletonPostWarmupComplete</cite> method which allows
Modules to hook into the server lifecycle after external ports have been bound, clients have been
resolved, and the server is ready to accept traffic but <em>before</em> the <cite>App#run</cite> or <cite>Server#start</cite>
callbacks are invoked.</p>
<p>E.g,</p>
<div class="code scala highlight-text notranslate"><div class="highlight"><pre><span></span>import com.twitter.inject.{Injector, TwitterModule}

object MyModule extends TwitterModule {

  override def singletonStartup(injector: Injector) {
    // initialize JVM-wide resources
  }

  override def singletonShutdown(injector: Injector) {
    // shutdown JVM-wide resources
  }

  override def singletonPostWarmupComplete(injector: Injector) {
    // perform functions that need to happen after we&#39;ve bound
    // ports but before the server has started
  }
}
</pre></div>
</div>
<div class="admonition important">
<p class="first admonition-title">Important</p>
<p class="last">Please note that the lifecycle is for <strong>Singleton</strong>-scoped resources and users should still
avoid binding unscoped resources without ways to shutdown or close them.</p>
</div>
<p>There is also the option to inline the logic for closing your resource using the
<cite>TwitterModuleLifecycle#onExit(f: =&gt; Unit)</cite> function.</p>
<p>For example, assume we have a class, <cite>SomeClient</cite> with a <cite>close()</cite> method that returns a <cite>Future[Unit]</cite>:</p>
<div class="code scala highlight-text notranslate"><div class="highlight"><pre><span></span>class SomeClient(
  configurationParam1: Int,
  configurationParam2: Double) {

  def withAnotherParam(b: Boolean): SomeClient = ???
  def withSomeOtherConfiguration(i: Int): SomeClient = ???

  /** Closes this client, freeing any held resources */
  def close(): Future[Unit] = {
    ???
  }
}
</pre></div>
</div>
<p>We could then register a function to close it, which will be run upon graceful shutdown of the application
by doing the following:</p>
<div class="code scala highlight-text notranslate"><div class="highlight"><pre><span></span>import com.google.inject.Provides
import com.twitter.conversions.DurationOps._
import com.twitter.inject.{Injector, TwitterModule}
import com.twitter.inject.annotations.Flag
import com.twitter.util.Await
import javax.inject.Singleton

object MyModule extends TwitterModule {
  flag[Int](&quot;configuration.param1&quot;, 42, &quot;This is used to configure an instance of a Wicket&quot;)
  flag[Double](&quot;configuration.param2&quot;, 123.45d, &quot;This is also used to configure an instance of a Wicket&quot;)

  @Provides
  @Singleton
  def providesSomeClient(
    @Flag(&quot;configuration.param1&quot;) configurationParam1: Int,
    @Flag(&quot;configuration.param2&quot;) configurationParam2: Double
  ): SomeClient = {
    val client =
      new SomeClient(configurationParam1, configurationParam2)
        .withAnotherParam(b = true)
        .withSomeOtherConfiguration(137)

    onExit {
       Await.result(client.close(), 2.seconds)
    }

    client
  }
}
</pre></div>
</div>
<p>or in Java:</p>
<div class="code java highlight-text notranslate"><div class="highlight"><pre><span></span>import com.google.inject.Provides;
import com.twitter.inject.Injector;
import com.twitter.inject.TwitterModule;
import com.twitter.inject.annotations.Flag;
import com.twitter.util.Await;
import com.twitter.util.Duration;
import com.twitter.util.Function0;
import javax.inject.Singleton;

public final class MyModule extends TwitterModule {

  public MyModule() {
    createFlag(
      /* name      = */ &quot;configuration.param1&quot;,
      /* default   = */ 42,
      /* help      = */ &quot;This is used to configure an instance of a Wicket&quot;,
      /* flaggable = */ Flaggable.ofJavaInteger());

    createFlag(
      /* name      = */ &quot;configuration.param2&quot;,
      /* default   = */ 123.45d,
      /* help      = */ &quot;This is also used to configure an instance of a Wicket&quot;,
      /* flaggable = */ Flaggable.ofJavaDouble());
  }

  @Provides
  @Singleton
  public SomeClient providesSomeClient(
    @Flag(&quot;configuration.param1&quot;) int configurationParam1,
    @Flag(&quot;configuration.param2&quot;) double configurationParam2) {
    SomeClient client =
      new SomeClient(configurationParam1, configurationParam2)
        .withAnotherParam(true)
        .withSomeOtherConfiguration(137)

    onExit(() -&gt; Await.result(client.close(), Duration.fromSeconds(2)));;

    return client;
  }
}
</pre></div>
</div>
<p>This allows for not needing to implement the <cite>singletonShutdown</cite> method which would require that you
obtain an instance of the singleton resource from the Injector to then call the <cite>close()</cite> function.</p>
<p>Any logic passed to the <cite>onExit</cite> function is added to the application’s list of <cite>onExit</cite>
functions to be run in the order registered upon graceful shutdown of the application.</p>
<p>For an example, see the <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/inject/inject-thrift-client/src/main/scala/com/twitter/inject/thrift/modules/ThriftMethodBuilderClientModule.scala">c.t.inject.thrift.modules.ThriftMethodBuilderClientModule</a>
where we use <cite>onExit</cite> to ensure that any bound ThriftClient will be closed when the application
gracefully exits.</p>
<p>See the <a class="reference external" href="lifecycle.html">Application and Server Lifecycle</a> section for more information on the
application and server lifecycle.</p>
<p>Lastly, see Guice’s documentation on <a class="reference external" href="https://github.com/google/guice/wiki/ModulesShouldBeFastAndSideEffectFree">Modules should be fast and side-effect free</a>
and <a class="reference external" href="https://github.com/google/guice/wiki/Avoid-Injecting-Closable-Resources">Avoid Injecting Closable Resources</a>
for more thoughts on providing resources with modules.</p>
</div>
<div class="section" id="modules-depending-on-other-modules">
<h2>Modules Depending on Other Modules<a class="headerlink" href="#modules-depending-on-other-modules" title="Permalink to this headline">¶</a></h2>
<p>As noted in the <a class="reference external" href="#differences-with-google-guice-modules">Differences with Google Guice Modules</a>
section, a <cite>c.t.inject.TwitterModule</cite> has an associated lifecycle and thus you should prefer to
<strong>not</strong> install an instance of a <cite>c.t.inject.TwitterModule</cite> using <a class="reference external" href="https://google.github.io/guice/api-docs/4.2/javadoc/com/google/inject/Binder.html#install-com.google.inject.Module-">Binder#install</a>
inside of <cite>Module#configure()</cite>.</p>
<p>However, we recognize that there may be times where you would like to reuse types bound by one Module
inside another Module. For instance, you may have a Module which provides a type <cite>Foo</cite> and need that
instance when constructing a type <cite>Bar</cite> in another Module. E.g.</p>
<div class="code scala highlight-text notranslate"><div class="highlight"><pre><span></span>import com.google.inject.Provides
import com.twitter.inject.TwitterModule
import javax.inject.Singleton

object FooModule extends TwitterModule {

  @Singleton
  @Provides
  def providesFoo: Foo = {
    new Foo(???)
  }
}
</pre></div>
</div>
<p>How do you get access to the bound instance of Foo inside of another Module?</p>
<p>Most often you are trying to inject the bound instance into a class as a class constructor-arg. E.g.,</p>
<div class="code scala highlight-text notranslate"><div class="highlight"><pre><span></span>import javax.inject.{Inject, Singleton}

@Singleton
class MyClassFoo @Inject()(foo: Foo) {
  ???
}
</pre></div>
</div>
<p>You can do something similar in a Module. However, instead of the injection point being the
constructor annotated with <code class="docutils literal notranslate"><span class="pre">&#64;Inject</span></code>, it is the argument list of any <code class="docutils literal notranslate"><span class="pre">&#64;Provides</span></code>-annotated
method. So to get an instance of a provided <cite>Foo</cite> inside of our <cite>BarModule</cite> we can do:</p>
<div class="code scala highlight-text notranslate"><div class="highlight"><pre><span></span>import com.google.inject.{Module, Provides}
import com.twitter.inject.TwitterModule
import javax.inject.Singleton

object BarModule extends TwitterModule {

  override val modules: Seq[Module] = Seq(FooModule)

  @Singleton
  @Provides
  def providesBar(foo: Foo): Bar = {
    new Bar(foo)
  }
}
</pre></div>
</div>
<p>in Java:</p>
<div class="code java highlight-text notranslate"><div class="highlight"><pre><span></span>import com.google.inject.Module;
import com.google.inject.Provides;
import com.twitter.inject.TwitterModule;
import javax.inject.Singleton;
import java.util.Collection;
import java.util.Collections;

public class BarModule extends TwitterModule {

  @Override
  public Collection&lt;Module&gt; javaModules() {
    return Collections.singletonList(
        FooModule$.MODULE$);
  }

  @Singleton
  @Provides
  public Bar providesBar(Foo foo) {
    return new Bar(foo);
  }
}
</pre></div>
</div>
<p>What’s happening here?</p>
<p>Firstly, we’ve defined a <cite>BarModule</cite> that overrides the <cite>modules</cite> val with a <cite>Seq</cite> (or the
<cite>javaModules</cite> def with a <cite>Collection</cite> in Java) of Modules that includes the <cite>FooModule</cite>. This
guarantees that if the <cite>FooModule</cite> is not mixed into the list of Modules for a server, the <cite>BarModule</cite>
ensures it will be installed since it’s declared as a dependency and thus there will be a bound
instance of <cite>Foo</cite> available for use in providing an instance of <cite>Bar</cite>.</p>
<p>Finatra will de-duplicate all Modules before installing, so it is OK if a Module appears twice in the
server configuration, though you should strive to make this the exception.</p>
<div class="admonition important">
<p class="first admonition-title">Important</p>
<p class="last">Reminder: It is important that the framework install all <cite>TwitterModules</cite> such that the <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/inject/inject-core/src/main/scala/com/twitter/inject/TwitterModuleLifecycle.scala">lifecycle functions</a>
are executed in the proper sequence and any <cite>TwitterModule</cite> defined <a class="reference external" href="flags.html">Flags</a> are
parsed properly.</p>
</div>
<p>Secondly, we’ve defined a method which provides a <cite>Bar</cite> instance and add an argument of type <cite>Foo</cite>
which will be provided by the Injector since injection is by type and the argument list to an
<code class="docutils literal notranslate"><span class="pre">&#64;Provides</span></code> annotated method in a Module is an injection point.</p>
<p>Why?</p>
<p>Because the Injector is what calls the <cite>providesBar</cite> method. When the Injector needs to provide an
instance of <cite>Bar</cite> it looks for a “provider” of <cite>Bar</cite> in the list of Modules. It will thus try to
supply all arguments to the function from the object graph.</p>
<p>We could continue this through another Module. For example, if we wanted to provide a <cite>Baz</cite> which
needs both a <cite>Foo</cite> and a <cite>Bar</cite> instance we could define a <cite>BazModule</cite>:</p>
<div class="code scala highlight-text notranslate"><div class="highlight"><pre><span></span>import com.google.inject.{Module, Provides}
import com.twitter.inject.TwitterModule
import javax.inject.Singleton

object BazModule extends TwitterModule {

  override val modules: Seq[Module] = Seq(
    FooModule,
    BarModule)

  @Singleton
  @Provides
  def providesBaz(
    foo: Foo,
    bar: Bar): Baz = {
    new Baz(foo, bar)
  }
}
</pre></div>
</div>
<p>in Java:</p>
<div class="code java highlight-text notranslate"><div class="highlight"><pre><span></span>import com.google.inject.Module;
import com.google.inject.Provides;
import com.twitter.inject.TwitterModule;
import javax.inject.Singleton;
import java.util.Arrays;
import java.util.Collection;
import java.util.Collections;

public class BazModule extends TwitterModule {

  @Override
  public Collection&lt;Module&gt; javaModules() {
    return Collections.unmodifiableList(
        Arrays.asList(
          FooModule$.MODULE$,
          BarModule$.MODULE$));
  }

  @Singleton
  @Provides
  public Baz providesBaz(Foo foo, Bar bar) {
    return new Baz(foo, bar);
  }
}
</pre></div>
</div>
<p>Notice that we have chosen to list both the <cite>FooModule</cite> and <cite>BarModule</cite> in the Modules for the
<cite>BazModule</cite>. Yet, since we know that the <cite>BarModule</cite> includes the <cite>FooModule</cite> we could have chosen
to leave it out. The <cite>providesBaz</cite> method in the Module above takes in both <cite>Foo</cite> and a <cite>Bar</cite>
instances as arguments.</p>
<p>Since it declares the two Modules, we’re assured that instances of these types will be available
from the Injector for our <cite>providesBaz</cite> method to use.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Users should prefer this method of depending on the bindings provided by another Module
over using <a class="reference external" href="https://google.github.io/guice/api-docs/4.2/javadoc/com/google/inject/Binder.html#install-com.google.inject.Module-">Binder#install</a>
as this will ensure that the lifecycle of a <cite>c.t.inject.TwitterModule</cite> is properly exercised when
the Module is installed.</p>
</div>
</div>
<div class="section" id="id4">
<h2>Best Practices<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Do not install a <cite>TwitterModule</cite> within another Module via <cite>Module#configure</cite> using <a class="reference external" href="https://google.github.io/guice/api-docs/4.2/javadoc/com/google/inject/Binder.html#install-com.google.inject.Module-">Binder#install</a>.
Installing a <cite>TwitterModule</cite> with this mechanism will skip all <a class="reference external" href="#module-lifecycle">lifecycle functions</a>
and any <a class="reference external" href="./flags.html">Flags</a> defined within the <cite>TwitterModule</cite> <strong>will not be parsed</strong>.</li>
<li>We recommend that you prefer using <code class="docutils literal notranslate"><span class="pre">&#64;Provides</span></code>-annotated methods over using the <cite>toInstance</cite>
<a class="reference external" href="https://github.com/google/guice/wiki/InstanceBindings">bind DSL</a>.</li>
<li>In Scala, Modules should usually be defined as Scala <em>objects</em> as they typically contain no state and using
an object makes use of the Module less verbose.</li>
<li>Remember to add <code class="docutils literal notranslate"><span class="pre">&#64;Singleton</span></code> to your <code class="docutils literal notranslate"><span class="pre">&#64;Provides</span></code> method if you require only <strong>one</strong> instance
per JVM process.</li>
<li>Avoid <a class="reference external" href="dependency_injection.html#avoid-cyclic-dependencies">cyclic dependencies</a>.</li>
<li>Avoid <a class="reference external" href="dependency_injection.html#avoid-conditional-logic-in-modules">conditional logic</a> in a <cite>TwitterModule</cite>.</li>
<li>Make use of the <cite>TwitterModule</cite> <a class="reference external" href="#module-lifecycle">lifecycle</a>.</li>
<li>Make use of the <a class="reference external" href="../testing/integration_tests.html#id2">TestInjector</a> for integration testing
with <cite>TwitterModules</cite> as this will correctly handle the lifecycle and Flag parsing of
<cite>TwitterModules</cite> to create a <cite>c.t.inject.Injector</cite>.</li>
</ul>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/finatra_logo.png" alt="Logo"/>
            </a></p><p>
  <a href="https://github.com/twitter/finatra">Finatra</a> is a Scala services framework built on top of <a href="https://twitter.github.io/twitter-server/">TwitterServer</a> and <a href="https://twitter.github.io/finagle/">Finagle</a>.
</p>

<h3>Useful Links</h3>
<ul>
  <li><a href="https://twitter.github.io/finatra/user-guide">User's&nbsp;Guide</a></li>
  <li><a href="https://finagle.github.io/blog/">Finagle&nbsp;Blog</a></li>
  <li><a href="https://github.com/twitter/finatra">Finatra&nbsp;on&nbsp;Github</a></li>
  <li><a href="https://github.com/twitter/finatra/issues">Github&nbsp;Issues</a></li>
</ul>
  <h3><a href="../../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Modules</a><ul>
<li><a class="reference internal" href="#c-t-inject-twittermodule">c.t.inject.TwitterModule</a></li>
<li><a class="reference internal" href="#differences-with-google-guice-modules">Differences with Google Guice Modules</a></li>
<li><a class="reference internal" href="#defining-modules">Defining Modules</a><ul>
<li><a class="reference internal" href="#provides"><code class="docutils literal notranslate"><span class="pre">&#64;Provides</span></code></a></li>
<li><a class="reference internal" href="#flags-in-modules">Flags in Modules</a></li>
</ul>
</li>
<li><a class="reference internal" href="#module-configuration-in-servers">Module Configuration in Servers</a></li>
<li><a class="reference internal" href="#module-lifecycle">Module Lifecycle</a></li>
<li><a class="reference internal" href="#modules-depending-on-other-modules">Modules Depending on Other Modules</a></li>
<li><a class="reference internal" href="#id4">Best Practices</a></li>
</ul>
</li>
</ul>
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">User’s Guide</a><ul>
      <li>Previous: <a href="lifecycle.html" title="previous chapter">Application and Server Lifecycle</a></li>
      <li>Next: <a href="binding_annotations.html" title="next chapter">Binding Annotations</a></li>
  </ul></li>
  </ul></li>
</ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Search the contents of this site.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
  
    <div class="github-fork-ribbon-wrapper right fixed" style="width: 150px;height: 150px;position: fixed;overflow: hidden;top: 0;z-index: 9999;pointer-events: none;right: 0;"><div class="github-fork-ribbon" style="position: absolute;padding: 2px 0;background-color: #900;background-image: linear-gradient(to bottom, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.15));-webkit-box-shadow: 0 2px 3px 0 rgba(0, 0, 0, 0.5);-moz-box-shadow: 0 2px 3px 0 rgba(0, 0, 0, 0.5);box-shadow: 0 2px 3px 0 rgba(0, 0, 0, 0.5);z-index: 9999;pointer-events: auto;top: 42px;right: -43px;-webkit-transform: rotate(45deg);-moz-transform: rotate(45deg);-ms-transform: rotate(45deg);-o-transform: rotate(45deg);transform: rotate(45deg);"><a target="_blank" href="https://github.com/twitter/finatra" style="font: 700 13px &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;color: #fff;text-decoration: none;text-shadow: 0 -1px rgba(0, 0, 0, 0.5);text-align: center;width: 200px;line-height: 20px;display: inline-block;padding: 2px 0;border-width: 1px 0;border-style: dotted;border-color: rgba(255, 255, 255, 0.7);">Fork me on GitHub</a></div></div>
  

  <div class="footer">
    &copy; Copyright 2013-2022 Twitter, Inc.
    Created using <a href="http://sphinx.pocoo.org/">Sphinx</div>
  
  </body>
</html>