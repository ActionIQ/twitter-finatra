
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>Dependency Injection &#8212; Finatra 20.4.0 documentation</title>
    <link rel="stylesheet" href="../../_static/flasky.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Understanding the Codebase" href="framework.html" />
    <link rel="prev" title="User’s Guide" href="../index.html" />
   
  
  <link media="only screen and (max-device-width: 480px)" href="../../_static/small_flask.css" type= "text/css" rel="stylesheet" />
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-39101739-4', 'twitter.github.io');
    ga('send', 'pageview');

  </script>

  </head><body>
  
  

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="framework.html" title="Understanding the Codebase"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../index.html" title="User’s Guide"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Finatra</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">User’s Guide</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="dependency-injection">
<span id="basics"></span><h1>Dependency Injection<a class="headerlink" href="#dependency-injection" title="Permalink to this headline">¶</a></h1>
<p>The Finatra framework uses <a class="reference external" href="https://en.wikipedia.org/wiki/Dependency_injection">Dependency Injection</a> (DI) and it is important to understand the concept – specifically how it relates to effective testing which helps to explain the motivations of the framework.</p>
<p><a class="reference external" href="https://en.wikipedia.org/wiki/Dependency_injection">Dependency Injection</a> is one way to implement the <a class="reference external" href="https://en.wikipedia.org/wiki/Inversion_of_control">Inversion of Control (IoC)</a> programming principle. More importantly <a class="reference external" href="https://en.wikipedia.org/wiki/Dependency_injection">Dependency Injection</a> is a <strong>design pattern</strong> and does not refer to any specific implementation of a library.</p>
<p>Finatra does use the Google <a class="reference external" href="https://github.com/google/guice">Guice</a> <a class="reference external" href="https://en.wikipedia.org/wiki/Dependency_injection">Dependency Injection</a> library which is also available for service writers if they choose to use <a class="reference external" href="https://en.wikipedia.org/wiki/Dependency_injection">Dependency Injection</a>. However, the framework was designed around the principle of <a class="reference external" href="https://en.wikipedia.org/wiki/Dependency_injection">Dependency Injection</a>, not the <a class="reference external" href="https://github.com/google/guice">Guice</a> library implementation with a primary goal to build testability of code into the framework.</p>
<p>With that, a great place to start on understanding the reasoning behind <a class="reference external" href="https://en.wikipedia.org/wiki/Dependency_injection">Dependency Injection</a>  is the <a class="reference external" href="https://github.com/google/guice/wiki/Motivation">Motivation</a> section of the Google <a class="reference external" href="https://github.com/google/guice">Guice</a> framework.</p>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>You are <strong>not required</strong> to use Google <a class="reference external" href="https://github.com/google/guice">Guice</a> <a class="reference external" href="https://en.wikipedia.org/wiki/Dependency_injection">Dependency Injection</a> when using Finatra. Creating servers, wiring in controllers and applying filters can all be done without using any dependency injection. However, you will not be able to take full-advantage of Finatra’s <a class="reference external" href="../testing/index.html">testing</a> features.</p>
</div>
<p>A simple example of Finatra’s <a class="reference external" href="https://en.wikipedia.org/wiki/Dependency_injection">Dependency Injection</a>  integration is adding controllers to Finatra’s <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/http/src/main/scala/com/twitter/finatra/http/routing/HttpRouter.scala">HttpRouter</a> <em>by type</em>:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Server</span> <span class="k">extends</span> <span class="nc">HttpServer</span> <span class="o">{</span>
  <span class="k">override</span> <span class="k">def</span> <span class="n">configureHttp</span><span class="o">(</span><span class="n">router</span><span class="k">:</span> <span class="kt">HttpRouter</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">router</span><span class="o">.</span><span class="n">add</span><span class="o">[</span><span class="kt">MyController</span><span class="o">]</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>As mentioned, it is also possible to do this without using <a class="reference external" href="https://github.com/google/guice">Guice</a>: simply instantiate your controller and add the instance to the router:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">NonDIServer</span> <span class="k">extends</span> <span class="nc">HttpServer</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">myController</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">MyController</span><span class="o">(...)</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">configureHttp</span><span class="o">(</span><span class="n">router</span><span class="k">:</span> <span class="kt">HttpRouter</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">router</span><span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="n">myController</span><span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="section" id="dependency-injection-and-testing">
<h1>Dependency Injection and Testing<a class="headerlink" href="#dependency-injection-and-testing" title="Permalink to this headline">¶</a></h1>
<p>There are many resources around this topic but we recommend taking a look at <a class="reference external" href="https://jasonpolites.github.io/tao-of-testing/ch3-1.1.html">The Tao of Testing: Chapter 3 - Dependency Injection</a> as a primer for how <a class="reference external" href="https://en.wikipedia.org/wiki/Dependency_injection">Dependency Injection</a> can help to write more testable code.</p>
</div>
<div class="section" id="dependency-injection-best-practices">
<h1>Dependency Injection Best Practices<a class="headerlink" href="#dependency-injection-best-practices" title="Permalink to this headline">¶</a></h1>
<p>To aid in making code more testable here are a few best practices to consider when working with Dependency Injection. These are generally good to follow regardless of the dependency injection framework being used and some are described in detail in the Google <a class="reference external" href="https://github.com/google/guice/wiki">Guice documentation</a>.</p>
<div class="section" id="use-constructor-injection">
<h2>Use Constructor Injection<a class="headerlink" href="#use-constructor-injection" title="Permalink to this headline">¶</a></h2>
<p>Finatra highly recommends using constructor injection to create immutable objects. Immutability allows objects to be simple, shareable and composable. For example:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">javax.inject.Inject</span>

<span class="k">class</span> <span class="nc">RealPaymentService</span> <span class="nd">@Inject</span><span class="o">()(</span>
  <span class="n">paymentQueue</span><span class="k">:</span> <span class="kt">PaymentQueue</span><span class="o">,</span>
  <span class="n">notifier</span><span class="k">:</span> <span class="kt">Notifier</span>
<span class="o">)</span>
</pre></div>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>While it may look odd, please note the position of the <cite>&#64;Inject()</cite> on the Scala class constructor. The parens are needed as the syntax requires constructor annotations to have exactly one parameter list, possibly empty.</p>
</div>
<p>or in Java</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">javax.inject.Inject</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RealPaymentService</span> <span class="p">{</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="n">PaymentQueue</span> <span class="n">paymentQueue</span><span class="p">;</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="n">Notifier</span> <span class="n">notifier</span><span class="p">;</span>

  <span class="nd">@Inject</span>
  <span class="kd">public</span> <span class="nf">RealPaymentService</span><span class="p">(</span>
    <span class="n">PaymentQueue</span> <span class="n">paymentQueue</span><span class="p">,</span>
    <span class="n">Notifier</span> <span class="n">notifier</span>
  <span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="na">paymentQueue</span> <span class="o">=</span> <span class="n">paymentQueue</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="na">notifier</span> <span class="o">=</span> <span class="n">notifier</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This clearly expresses that the <cite>RealPaymentService</cite> class requires a <cite>PaymentQueue</cite> and a <cite>Notifier</cite> for instantiation and allows for instantiation via injector <em>or</em> manual instantiation of the class. This way of defining injectable members for a class is preferable to <a class="reference external" href="https://github.com/google/guice/wiki/Injections#field-injection">Field Injection</a> or <a class="reference external" href="https://github.com/google/guice/wiki/Injections#method-injection">Method Injection</a>.</p>
<div class="admonition-do-not-use-constructor-default-parameter-values admonition">
<p class="admonition-title">Do not use constructor default parameter values</p>
<p>Scala allows for <a class="reference external" href="https://docs.scala-lang.org/tour/default-parameter-values.html">default parameter values</a>.
E.g., you can define a class with a constructor like so:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">RealPaymentService</span> <span class="o">(</span>
  <span class="n">paymentQueue</span><span class="k">:</span> <span class="kt">PaymentQueue</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DefaultPaymentQueue</span><span class="o">,</span>
  <span class="n">notifier</span><span class="k">:</span> <span class="kt">Notifier</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DefaultNotifier</span>
<span class="o">)</span>
</pre></div>
</div>
<p>However, if you want to allow for the injector to be able to create this class by adding <cite>&#64;Inject()</cite> to the constructor it is highly recommended that you <strong>do not provide a default value for any constructor parameters</strong> as this can confuse the injector.</p>
<p>If you want to provide an instance with defaulted state for injection, prefer providing the instance via a defined
<a class="reference external" href="./modules.html">Module</a> instead.</p>
</div>
<div class="section" id="assistedinject">
<h3>AssistedInject<a class="headerlink" href="#assistedinject" title="Permalink to this headline">¶</a></h3>
<p>There may be cases where you do not want the injector to provide all arguments of the constructor. In these cases
you could use <a class="reference external" href="https://github.com/google/guice/wiki/AssistedInject">AssistedInject</a>.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">com.google.inject.assistedinject.Assisted</span>
<span class="k">import</span> <span class="nn">javax.inject.Inject</span>

<span class="k">class</span> <span class="nc">RealPaymentService</span> <span class="nd">@Inject</span><span class="o">()(</span>
  <span class="nd">@Assisted</span> <span class="n">paymentQueue</span><span class="k">:</span> <span class="kt">PaymentQueue</span><span class="o">,</span>
  <span class="n">notifier</span><span class="k">:</span> <span class="kt">Notifier</span>
<span class="o">)</span>
</pre></div>
</div>
<p>where “assisted” here means that injection will be <em>assisted</em> by having a user-supplied value provided for
the annotated field to use in constructing an instance of the object.</p>
<p>You would typically also create a “factory” which exposes a method that accepts the <cite>&#64;Assisted</cite> annotated field:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">trait</span> <span class="nc">RealPaymentServiceFactory</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">create</span><span class="o">(</span><span class="n">paymentQueue</span><span class="k">:</span> <span class="kt">PaymentQueue</span><span class="o">)</span><span class="k">:</span> <span class="kt">RealPaymentService</span>
<span class="o">}</span>
</pre></div>
</div>
<p>Then bind this as an “assisted factory” in a <cite>TwitterModule</cite> and include the module in your server’s
list of modules.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">com.twitter.inject.TwitterModule</span>

<span class="k">class</span> <span class="nc">PaymentServiceModule</span> <span class="k">extends</span> <span class="nc">TwitterModule</span> <span class="o">{</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">configure</span><span class="o">()</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
    <span class="n">bindAssistedFactory</span><span class="o">[</span><span class="kt">RealPaymentServiceFactory</span><span class="o">]()</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>To obtain an instance you would get a reference to the factory from the injector and call the
factory method:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">factory</span> <span class="k">=</span> <span class="n">injector</span><span class="o">.</span><span class="n">instance</span><span class="o">[</span><span class="kt">RealPaymentServiceFactory</span><span class="o">]</span>
<span class="k">val</span> <span class="n">paymentService</span><span class="k">:</span> <span class="kt">RealPaymentService</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="n">create</span><span class="o">(</span><span class="k">new</span> <span class="nc">MyPaymentQueue</span><span class="o">)</span>
</pre></div>
</div>
<p>For Java examples please see the <a class="reference external" href="https://github.com/google/guice/wiki/AssistedInject">Guice documentation</a>.</p>
</div>
<div class="section" id="field-injection-not-recommended">
<h3>Field Injection (not recommended)<a class="headerlink" href="#field-injection-not-recommended" title="Permalink to this headline">¶</a></h3>
<p>If you want to do field injection in a Scala class (again, not recommended), you would do so inside of the defined class on a mutable member of the class. Note that this introduces mutability into your class and is not something generally recommended.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">javax.inject.Inject</span>

<span class="k">class</span> <span class="nc">LessIdealPaymentService</span> <span class="o">{</span>
  <span class="nd">@Inject</span>
  <span class="k">private</span> <span class="k">var</span> <span class="n">notifier</span><span class="k">:</span> <span class="kt">Notifier</span> <span class="o">=</span> <span class="k">_</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="section" id="injecting-third-party-code">
<h3>Injecting third-party code<a class="headerlink" href="#injecting-third-party-code" title="Permalink to this headline">¶</a></h3>
<p>If you want to be able to inject a type that is not a class you own – meaning you cannot annotate the class or its constructor since it is not your code but you want to be able to inject an instance of the type, then prefer defining a <a class="reference external" href="./modules.html">Module</a> which can provide an (ideally immutable) instance of the class to the object graph.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The Guice documentation recommends <a class="reference external" href="https://github.com/google/guice/wiki/KeepConstructorsHidden">keeping constructors hidden</a> for classes which are meant to be instantiated by the injector. If you prefer constructor injection to create immutable objects, the difference between manual instantiation and injector instantiation should only come down to scoping of the created instance, i.e., is it a Singleton (the same instance every time from the injector). Finatra takes the approach of the <cite>&#64;Inject</cite> annotation being metadata in that it signals that the class <em>can</em> be instantiated by the injector but it is not a requirement.</p>
<p>We leave reducing the visibility of constructors to your discretion as a matter of what makes sense for your project or team.</p>
</div>
</div>
</div>
<div class="section" id="inject-direct-dependencies">
<h2>Inject direct dependencies<a class="headerlink" href="#inject-direct-dependencies" title="Permalink to this headline">¶</a></h2>
<p>Avoid injecting an object simply as a way to get another object. For instance do not inject a <cite>Customer</cite> simply to obtain an <cite>Account</cite>:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Budget</span> <span class="nd">@Inject</span><span class="o">()(</span>
  <span class="n">customer</span><span class="k">:</span> <span class="kt">Customer</span>
<span class="o">)</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">account</span><span class="k">:</span> <span class="kt">Account</span> <span class="o">=</span> <span class="n">customer</span><span class="o">.</span><span class="n">purchasingAccount</span>
<span class="o">}</span>
</pre></div>
</div>
<p>Instead, you should prefer to inject this dependency directly since this can make testing easier because your tests do not need to know anything about the <cite>Customer</cite> object. This is where defining a <a class="reference external" href="./modules.html">Module</a> is useful. Using an <cite>&#64;Provides</cite>-annotated method you can create a binding for <cite>Account</cite> which comes from a <cite>Customer</cite> binding:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">CustomersModule</span> <span class="k">extends</span> <span class="nc">TwitterModule</span> <span class="o">{</span>

  <span class="nd">@Provides</span>
  <span class="k">def</span> <span class="n">providePurchasingAccount</span><span class="o">(</span>
    <span class="n">customer</span><span class="k">:</span> <span class="kt">Customer</span>
  <span class="o">)</span><span class="k">:</span> <span class="kt">Account</span> <span class="o">=</span> <span class="o">{</span>
    <span class="n">customer</span><span class="o">.</span><span class="n">purchasingAccount</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>Injecting this binding makes the code simpler:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Budget</span> <span class="nd">@Inject</span><span class="o">()(</span><span class="n">account</span><span class="k">:</span> <span class="kt">Account</span><span class="o">)</span>
</pre></div>
</div>
</div>
<div class="section" id="avoid-cyclic-dependencies">
<h2>Avoid cyclic dependencies<a class="headerlink" href="#avoid-cyclic-dependencies" title="Permalink to this headline">¶</a></h2>
<p>This is good practice in general and cycles often reflect insufficiently granular decomposition. For instance, assume you have a <cite>Store</cite>, a <cite>Boss</cite>, and a <cite>Clerk</cite>.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Store</span> <span class="nd">@Inject</span><span class="o">()(</span><span class="n">boss</span><span class="k">:</span> <span class="kt">Boss</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">incomingCustomer</span><span class="o">(</span><span class="n">customer</span><span class="k">:</span> <span class="kt">Customer</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">???</span>
  <span class="k">def</span> <span class="n">nextCustomer</span><span class="k">:</span> <span class="kt">Customer</span> <span class="o">=</span> <span class="o">???</span>
<span class="o">}</span>

<span class="k">class</span> <span class="nc">Boss</span> <span class="nd">@Inject</span><span class="o">()(</span><span class="n">clerk</span><span class="k">:</span> <span class="kt">Clerk</span><span class="o">)</span>

<span class="k">class</span> <span class="nc">Clerk</span><span class="o">()</span>
</pre></div>
</div>
<p>So far, so good. Constructing a <cite>Store</cite> constructs a new <cite>Boss</cite> which in turn constructs a new <cite>Clerk</cite>. However, to give the <cite>Clerk</cite> a <cite>Customer</cite> in order to make a sale, the <cite>Clerk</cite> needs a reference to the <cite>Store</cite> to get those customers:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Store</span> <span class="nd">@Inject</span><span class="o">()(</span><span class="n">boss</span><span class="k">:</span> <span class="kt">Boss</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">incomingCustomer</span><span class="o">(</span><span class="n">customer</span><span class="k">:</span> <span class="kt">Customer</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">???</span>
  <span class="k">def</span> <span class="n">nextCustomer</span><span class="k">:</span> <span class="kt">Customer</span> <span class="o">=</span> <span class="o">???</span>
<span class="o">}</span>

<span class="k">class</span> <span class="nc">Boss</span> <span class="nd">@Inject</span><span class="o">()(</span><span class="n">clerk</span><span class="k">:</span> <span class="kt">Clerk</span><span class="o">)</span>

<span class="k">class</span> <span class="nc">Clerk</span> <span class="nd">@Inject</span><span class="o">()(</span><span class="n">store</span><span class="k">:</span> <span class="kt">Store</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">doSale</span><span class="o">()</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
    <span class="k">val</span> <span class="n">customer</span> <span class="k">=</span> <span class="n">store</span><span class="o">.</span><span class="n">nextCustomer</span>
    <span class="o">...</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>which now leads to a cycle, <cite>Clerk</cite> -&gt; <cite>Store</cite> -&gt; <cite>Boss</cite> -&gt; <cite>Clerk</cite>.</p>
<div class="section" id="eliminate-the-cycle-preferred">
<h3>Eliminate the cycle (preferred)<a class="headerlink" href="#eliminate-the-cycle-preferred" title="Permalink to this headline">¶</a></h3>
<p>One way to eliminate such cycles is to extract the dependency case into a separate class. In the contrived example, we could introduce a way of representing a line of eager customers as a <cite>CustomerLine</cite> which can be injected into a <cite>Clerk</cite> or a <cite>Store</cite>.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Store</span> <span class="nd">@Inject</span><span class="o">()(</span><span class="n">boss</span><span class="k">:</span> <span class="kt">Boss</span><span class="o">,</span> <span class="n">customers</span><span class="k">:</span> <span class="kt">CustomerLine</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">incomingCustomer</span><span class="o">(</span><span class="n">customer</span><span class="k">:</span> <span class="kt">Customer</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">???</span>
  <span class="k">def</span> <span class="n">nextCustomer</span><span class="k">:</span> <span class="kt">Customer</span> <span class="o">=</span> <span class="o">???</span>
<span class="o">}</span>

<span class="k">class</span> <span class="nc">Clerk</span> <span class="nd">@Inject</span><span class="o">()(</span><span class="n">customers</span><span class="k">:</span> <span class="kt">CustomerLine</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">doSale</span><span class="o">()</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
    <span class="k">val</span> <span class="n">customer</span> <span class="k">=</span> <span class="n">customers</span><span class="o">.</span><span class="n">nextCustomer</span>
    <span class="o">...</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p><cite>Store</cite> and <cite>Clerk</cite> now both depend on a <cite>CustomerLine</cite> (you should ensure that they use the same instance) and thus no longer a cycle in the graph.</p>
</div>
<div class="section" id="use-a-provider">
<h3>Use a Provider<a class="headerlink" href="#use-a-provider" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="https://github.com/google/guice/wiki/InjectingProviders">Injecting a Provider</a> allows you to inject a seam into the dependency graph. In this case, the <cite>Clerk</cite> still depends on a <cite>Store</cite> but the <cite>Clerk</cite> does not dereference the <cite>Store</cite> until needed by asking for it from the <cite>Provider[Store]</cite>:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Clerk</span> <span class="nd">@Inject</span><span class="o">()(</span>
  <span class="nc">Provider</span><span class="o">[</span><span class="kt">Store</span><span class="o">]</span> <span class="n">storeProvider</span>
<span class="o">)</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">doSale</span><span class="o">()</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
    <span class="k">val</span> <span class="n">customer</span> <span class="k">=</span> <span class="n">storeProvider</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">nextCustomer</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>Note: you should ensure in this case that the <cite>Store</cite> is bound as a <cite>Singleton</cite> (otherwise the <cite>Provider.get</cite> will instantiate a new <cite>Store</cite> which ends up in the cycle).</p>
</div>
</div>
<div class="section" id="avoid-i-o-with-providers">
<h2>Avoid I/O with Providers<a class="headerlink" href="#avoid-i-o-with-providers" title="Permalink to this headline">¶</a></h2>
<p>As we saw in the above example, Providers can be a useful API but it lacks some semantics that you should be aware of:</p>
<ul class="simple">
<li><p>If you need to recover from specific failures the Provider API only returns a generic <cite>ProvisionException</cite>. You can <a class="reference external" href="https://google.github.io/guice/api-docs/latest/javadoc/com/google/inject/ProvisionException.html#getErrorMessages()">iterate through the causes</a> but you will not be able to catch the specific type. See <a class="reference external" href="https://github.com/google/guice/wiki/ThrowingProviders">ThrowingProviders</a> for a way to declare thrown exceptions from a <cite>Provider</cite>.</p></li>
<li><p>No support for timeout. Thus you can deadlock waiting on the <cite>Provider</cite> to be available with a call to <cite>Provider.get</cite>.</p></li>
<li><p>There is no retry for obtaining the instance from a Provider. If <cite>Provider.get</cite> is unavailable, multiple calls to <cite>get</cite> may simply throw multiple exceptions.</p></li>
</ul>
</div>
<div class="section" id="avoid-conditional-logic-in-modules">
<h2>Avoid conditional logic in modules<a class="headerlink" href="#avoid-conditional-logic-in-modules" title="Permalink to this headline">¶</a></h2>
<p>It can be tempting to create <a class="reference external" href="./modules.html">Modules</a> which have conditional logic and can be configured to operate differently for different environments. We strongly recommend avoiding this pattern and the framework provides utilities (including <a class="reference external" href="./flags.html">Flags</a>) to help in this regard.</p>
<p>Please avoid doing this:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// DO NOT DO THIS</span>
<span class="k">class</span> <span class="nc">FooModule</span><span class="o">(</span><span class="n">fooServer</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">TwitterModule</span> <span class="o">{</span>
  <span class="k">override</span> <span class="k">protected</span> <span class="k">def</span> <span class="n">configure</span><span class="o">()</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">fooServer</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">bind</span><span class="o">[</span><span class="kt">String</span><span class="o">](</span><span class="nc">Names</span><span class="o">.</span><span class="n">named</span><span class="o">(</span><span class="s">&quot;fooServer&quot;</span><span class="o">)).</span><span class="n">toInstance</span><span class="o">(</span><span class="n">fooServer</span><span class="o">)</span>
      <span class="n">bind</span><span class="o">[</span><span class="kt">FooService</span><span class="o">].</span><span class="n">to</span><span class="o">[</span><span class="kt">RemoteService</span><span class="o">]</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="n">bind</span><span class="o">[</span><span class="kt">FooService</span><span class="o">].</span><span class="n">to</span><span class="o">[</span><span class="kt">InMemoryFooService</span><span class="o">]</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="c1">// NOR THIS</span>
<span class="k">class</span> <span class="nc">FooModule</span> <span class="k">extends</span> <span class="nc">TwitterModule</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">env</span> <span class="k">=</span> <span class="n">flag</span><span class="o">(</span><span class="s">&quot;env&quot;</span><span class="o">,</span> <span class="s">&quot;remote&quot;</span><span class="o">,</span> <span class="s">&quot;the environment&quot;</span><span class="o">)</span>

  <span class="k">override</span> <span class="k">protected</span> <span class="k">def</span> <span class="n">configure</span><span class="o">()</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">env</span><span class="o">()</span> <span class="o">==</span> <span class="s">&quot;remote&quot;</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">bind</span><span class="o">[</span><span class="kt">String</span><span class="o">](</span><span class="nc">Names</span><span class="o">.</span><span class="n">named</span><span class="o">(</span><span class="s">&quot;fooServer&quot;</span><span class="o">)).</span><span class="n">toInstance</span><span class="o">(</span><span class="n">fooServer</span><span class="o">)</span>
      <span class="n">bind</span><span class="o">[</span><span class="kt">FooService</span><span class="o">].</span><span class="n">to</span><span class="o">[</span><span class="kt">RemoteService</span><span class="o">]</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="n">bind</span><span class="o">[</span><span class="kt">FooService</span><span class="o">].</span><span class="n">to</span><span class="o">[</span><span class="kt">InMemoryFooService</span><span class="o">]</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>We <strong>strongly</strong> recommend that <em>only production code ever be deployed to production</em> and thus configuration which should change per environment be externalized via <a class="reference external" href="./flags.html">Flags</a> and logic that should differ per environment be encapsulated within <a class="reference external" href="../testing/override_modules.html">override modules</a> (that are not located with the production code – e.g., production code in <cite>src/main/scala</cite> and test code in <cite>src/test/scala</cite>).</p>
</div>
<p>For more information see the sections on <a class="reference external" href="./flags.html">Flags</a>, <a class="reference external" href="./modules.html">Modules</a>, and <a class="reference external" href="../testing/override_modules.html">Override Modules</a>.</p>
</div>
<div class="section" id="make-use-of-the-twittermodule-lifecycle">
<h2>Make use of the <cite>TwitterModule</cite> lifecycle<a class="headerlink" href="#make-use-of-the-twittermodule-lifecycle" title="Permalink to this headline">¶</a></h2>
<p>Finatra adds a lifecycle to Modules which is directly tied to the <a class="reference external" href="./lifecycle.html">server (or application) lifecycle</a> in which the module is used. This allows users to overcome some of the limitations of a standard <cite>AbstractModule</cite>.</p>
<p>The <a class="reference external" href="https://github.com/twitter/finatra/blob/f275df9ea4e00ea3690e63e72a5445bb2c98cea7/inject/inject-core/src/main/scala/com/twitter/inject/TwitterModuleLifecycle.scala#L9">c.t.inject.TwitterModuleLifecycle</a> defines several phases which allow users to setup and teardown or close <cite>Singleton</cite> scoped resources. Thus, you are able to bind closable resources with a defined way to release them.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Please note that the lifecycle is for <strong>Singleton</strong>-scoped resources and users should still avoid binding unscoped resources without ways to shutdown or close them.</p>
</div>
<p>See: Guice’s documentation on <a class="reference external" href="https://github.com/google/guice/wiki/ModulesShouldBeFastAndSideEffectFree">Modules should be fast and side-effect free</a> and <a class="reference external" href="https://github.com/google/guice/wiki/Avoid-Injecting-Closable-Resources">Avoid Injecting Closable Resources</a>.</p>
<p>For more information on Finatra Modules see the documentation <a class="reference external" href="./modules.html">here</a>.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><p>
  <a href="https://github.com/twitter/finatra">Finatra</a> is a Scala services framework built on top of <a href="https://twitter.github.io/twitter-server/">TwitterServer</a> and <a href="https://twitter.github.io/finagle/">Finagle</a>.
</p>

<h3>Useful Links</h3>
<ul>
  <li><a href="https://twitter.github.io/finatra/user-guide">User's&nbsp;Guide</a></li>
  <li><a href="https://finagle.github.io/blog/">Finagle&nbsp;Blog</a></li>
  <li><a href="https://github.com/twitter/finatra">Finatra&nbsp;on&nbsp;Github</a></li>
  <li><a href="https://github.com/twitter/finatra/issues">Github&nbsp;Issues</a></li>
</ul>
  <h3><a href="../../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Dependency Injection</a></li>
<li><a class="reference internal" href="#dependency-injection-and-testing">Dependency Injection and Testing</a></li>
<li><a class="reference internal" href="#dependency-injection-best-practices">Dependency Injection Best Practices</a><ul>
<li><a class="reference internal" href="#use-constructor-injection">Use Constructor Injection</a><ul>
<li><a class="reference internal" href="#assistedinject">AssistedInject</a></li>
<li><a class="reference internal" href="#field-injection-not-recommended">Field Injection (not recommended)</a></li>
<li><a class="reference internal" href="#injecting-third-party-code">Injecting third-party code</a></li>
</ul>
</li>
<li><a class="reference internal" href="#inject-direct-dependencies">Inject direct dependencies</a></li>
<li><a class="reference internal" href="#avoid-cyclic-dependencies">Avoid cyclic dependencies</a><ul>
<li><a class="reference internal" href="#eliminate-the-cycle-preferred">Eliminate the cycle (preferred)</a></li>
<li><a class="reference internal" href="#use-a-provider">Use a Provider</a></li>
</ul>
</li>
<li><a class="reference internal" href="#avoid-i-o-with-providers">Avoid I/O with Providers</a></li>
<li><a class="reference internal" href="#avoid-conditional-logic-in-modules">Avoid conditional logic in modules</a></li>
<li><a class="reference internal" href="#make-use-of-the-twittermodule-lifecycle">Make use of the <cite>TwitterModule</cite> lifecycle</a></li>
</ul>
</li>
</ul>
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">User’s Guide</a><ul>
      <li>Previous: <a href="../index.html" title="previous chapter">User’s Guide</a></li>
      <li>Next: <a href="framework.html" title="next chapter">Understanding the Codebase</a></li>
  </ul></li>
  </ul></li>
</ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Search the contents of this site.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
  
    <div class="github-fork-ribbon-wrapper right fixed" style="width: 150px;height: 150px;position: fixed;overflow: hidden;top: 0;z-index: 9999;pointer-events: none;right: 0;"><div class="github-fork-ribbon" style="position: absolute;padding: 2px 0;background-color: #900;background-image: linear-gradient(to bottom, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.15));-webkit-box-shadow: 0 2px 3px 0 rgba(0, 0, 0, 0.5);-moz-box-shadow: 0 2px 3px 0 rgba(0, 0, 0, 0.5);box-shadow: 0 2px 3px 0 rgba(0, 0, 0, 0.5);z-index: 9999;pointer-events: auto;top: 42px;right: -43px;-webkit-transform: rotate(45deg);-moz-transform: rotate(45deg);-ms-transform: rotate(45deg);-o-transform: rotate(45deg);transform: rotate(45deg);"><a target="_blank" href="https://github.com/twitter/finatra" style="font: 700 13px &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;color: #fff;text-decoration: none;text-shadow: 0 -1px rgba(0, 0, 0, 0.5);text-align: center;width: 200px;line-height: 20px;display: inline-block;padding: 2px 0;border-width: 1px 0;border-style: dotted;border-color: rgba(255, 255, 255, 0.7);">Fork me on GitHub</a></div></div>
  

  <div class="footer">
    &copy; Copyright 2013-2020 Twitter, Inc.
    Created using <a href="http://sphinx.pocoo.org/">Sphinx</div>
  
  </body>
</html>