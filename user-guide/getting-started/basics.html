
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Dependency Injection &#8212; Finatra 20.12.0 documentation</title>
    <link rel="stylesheet" href="../../_static/flasky.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '20.12.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Understanding the Codebase" href="framework.html" />
    <link rel="prev" title="User’s Guide" href="../index.html" />
   
  
  <link media="only screen and (max-device-width: 480px)" href="../../_static/small_flask.css" type= "text/css" rel="stylesheet" />
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-39101739-4', 'twitter.github.io');
    ga('send', 'pageview');

  </script>

  </head>
  <body>
  
  

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="framework.html" title="Understanding the Codebase"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../index.html" title="User’s Guide"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Finatra</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">User’s Guide</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="dependency-injection">
<span id="basics"></span><h1>Dependency Injection<a class="headerlink" href="#dependency-injection" title="Permalink to this headline">¶</a></h1>
<p>The Finatra framework uses <a class="reference external" href="https://en.wikipedia.org/wiki/Dependency_injection">Dependency Injection</a> (DI) and it is important to understand the concept – specifically how it relates to effective testing which helps to explain the motivations of the framework.</p>
<p><a class="reference external" href="https://en.wikipedia.org/wiki/Dependency_injection">Dependency Injection</a> is one way to implement the <a class="reference external" href="https://en.wikipedia.org/wiki/Inversion_of_control">Inversion of Control (IoC)</a> programming principle. More importantly <a class="reference external" href="https://en.wikipedia.org/wiki/Dependency_injection">Dependency Injection</a> is a <strong>design pattern</strong> and does not refer to any specific implementation of a library.</p>
<p>Finatra does use the Google <a class="reference external" href="https://github.com/google/guice">Guice</a> <a class="reference external" href="https://en.wikipedia.org/wiki/Dependency_injection">Dependency Injection</a> library which is also available for service writers if they choose to use <a class="reference external" href="https://en.wikipedia.org/wiki/Dependency_injection">Dependency Injection</a>. However, the framework was designed around the principle of <a class="reference external" href="https://en.wikipedia.org/wiki/Dependency_injection">Dependency Injection</a>, not the <a class="reference external" href="https://github.com/google/guice">Guice</a> library implementation with a primary goal to build testability of code into the framework.</p>
<p>With that, a great place to start on understanding the reasoning behind <a class="reference external" href="https://en.wikipedia.org/wiki/Dependency_injection">Dependency Injection</a>  is the <a class="reference external" href="https://github.com/google/guice/wiki/Motivation">Motivation</a> section of the Google <a class="reference external" href="https://github.com/google/guice">Guice</a> framework.</p>
<div class="admonition attention">
<p class="first admonition-title">Attention</p>
<p class="last">You are <strong>not required</strong> to use Google <a class="reference external" href="https://github.com/google/guice">Guice</a> <a class="reference external" href="https://en.wikipedia.org/wiki/Dependency_injection">Dependency Injection</a> when using Finatra. Creating servers, wiring in controllers and applying filters can all be done without using any dependency injection. However, you will not be able to take full-advantage of Finatra’s <a class="reference external" href="../testing/index.html">testing</a> features.</p>
</div>
<p>A simple example of Finatra’s <a class="reference external" href="https://en.wikipedia.org/wiki/Dependency_injection">Dependency Injection</a>  integration is adding controllers to Finatra’s <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/http/src/main/scala/com/twitter/finatra/http/routing/HttpRouter.scala">HttpRouter</a> <em>by type</em>:</p>
<div class="code scala highlight-text"><div class="highlight"><pre><span></span>class Server extends HttpServer {
  override def configureHttp(router: HttpRouter) {
    router.add[MyController]
  }
}
</pre></div>
</div>
<p>As mentioned, it is also possible to do this without using <a class="reference external" href="https://github.com/google/guice">Guice</a>: simply instantiate your controller and add the instance to the router:</p>
<div class="code scala highlight-text"><div class="highlight"><pre><span></span>class NonDIServer extends HttpServer {
  val myController = new MyController(...)

  override def configureHttp(router: HttpRouter) {
    router.add(myController)
  }
}
</pre></div>
</div>
<div class="section" id="what-is-this-doing">
<h2>What Is This Doing?<a class="headerlink" href="#what-is-this-doing" title="Permalink to this headline">¶</a></h2>
<p>When doing <cite>router.add[T]</cite>, you are instructing the framework to retrieve an instance of <cite>T</cite> from the object graph of
the server or application. Whereas <cite>router.add(instance)</cite> accepts the instance directly. This pattern is repeated
throughout the framework to provide users the choice of using the object graph or not.</p>
</div>
<div class="section" id="why-use-the-object-graph">
<h2>Why Use The Object Graph?<a class="headerlink" href="#why-use-the-object-graph" title="Permalink to this headline">¶</a></h2>
<p>A primary focus of the Finatra framework is to make it easy to test services and applications. We think using
the <a class="reference external" href="https://en.wikipedia.org/wiki/Dependency_injection">Dependency Injection</a> design pattern can lead to more
testable code (more on this topic in the next section) because an outcome of using the pattern is that dependencies
of the code under test can be replaced when testing.</p>
<p>Choosing to let the framework obtain an instance of <cite>T</cite> from the object graph means that the framework testing utilities
can provide ways for users to replace the instance of <cite>T</cite> returned in tests. When you provide the instance directly, it is thus up to you to build in any hooks in production code to replace instances and test code to set replacements if necessary when testing.</p>
</div>
</div>
<div class="section" id="dependency-injection-and-testing">
<h1>Dependency Injection and Testing<a class="headerlink" href="#dependency-injection-and-testing" title="Permalink to this headline">¶</a></h1>
<p>There are many resources around this topic but we recommend taking a look at <a class="reference external" href="https://jasonpolites.github.io/tao-of-testing/ch3-1.1.html">The Tao of Testing: Chapter 3 - Dependency Injection</a> as a primer for how <a class="reference external" href="https://en.wikipedia.org/wiki/Dependency_injection">Dependency Injection</a> can help to write more testable code.</p>
</div>
<div class="section" id="dependency-injection-best-practices">
<h1>Dependency Injection Best Practices<a class="headerlink" href="#dependency-injection-best-practices" title="Permalink to this headline">¶</a></h1>
<p>To aid in making code more testable here are a few best practices to consider when working with Dependency Injection. These are generally good to follow regardless of the dependency injection framework being used and some are described in detail in the Google <a class="reference external" href="https://github.com/google/guice/wiki">Guice documentation</a>.</p>
<div class="section" id="use-constructor-injection">
<h2>Use Constructor Injection<a class="headerlink" href="#use-constructor-injection" title="Permalink to this headline">¶</a></h2>
<p>Finatra highly recommends using constructor injection to create immutable objects. Immutability allows objects to be simple, shareable and composable. For example:</p>
<div class="code scala highlight-text"><div class="highlight"><pre><span></span>import javax.inject.Inject

class RealPaymentService @Inject()(
  paymentQueue: PaymentQueue,
  notifier: Notifier
)
</pre></div>
</div>
<div class="admonition important">
<p class="first admonition-title">Important</p>
<p class="last">While it may look odd, please note the position of the <cite>&#64;Inject()</cite> on the Scala class constructor. The parens are needed as the syntax requires constructor annotations to have exactly one parameter list, possibly empty.</p>
</div>
<p>or in Java</p>
<div class="code java highlight-text"><div class="highlight"><pre><span></span>import javax.inject.Inject;

public class RealPaymentService {
  private final PaymentQueue paymentQueue;
  private final Notifier notifier;

  @Inject
  public RealPaymentService(
    PaymentQueue paymentQueue,
    Notifier notifier
  ) {
    this.paymentQueue = paymentQueue;
    this.notifier = notifier;
  }
}
</pre></div>
</div>
<p>This clearly expresses that the <cite>RealPaymentService</cite> class requires a <cite>PaymentQueue</cite> and a <cite>Notifier</cite> for instantiation and allows for instantiation via injector <em>or</em> manual instantiation of the class. This way of defining injectable members for a class is preferable to <a class="reference external" href="https://github.com/google/guice/wiki/Injections#field-injection">Field Injection</a> or <a class="reference external" href="https://github.com/google/guice/wiki/Injections#method-injection">Method Injection</a>.</p>
<div class="admonition-do-not-use-constructor-default-parameter-values admonition">
<p class="first admonition-title">Do not use constructor default parameter values</p>
<p>Scala allows for <a class="reference external" href="https://docs.scala-lang.org/tour/default-parameter-values.html">default parameter values</a>.
E.g., you can define a class with a constructor like so:</p>
<div class="code scala highlight-text"><div class="highlight"><pre><span></span>class RealPaymentService (
  paymentQueue: PaymentQueue = new DefaultPaymentQueue,
  notifier: Notifier = new DefaultNotifier
)
</pre></div>
</div>
<p>However, if you want to allow for the injector to be able to create this class by adding <cite>&#64;Inject()</cite> to the constructor it is highly recommended that you <strong>do not provide a default value for any constructor parameters</strong> as this can confuse the injector.</p>
<p class="last">If you want to provide an instance with defaulted state for injection, prefer providing the instance via a defined
<a class="reference external" href="./modules.html">Module</a> instead.</p>
</div>
<div class="section" id="assistedinject">
<h3>AssistedInject<a class="headerlink" href="#assistedinject" title="Permalink to this headline">¶</a></h3>
<p>There may be cases where you do not want the injector to provide all arguments of the constructor. In these cases
you could use <a class="reference external" href="https://github.com/google/guice/wiki/AssistedInject">AssistedInject</a>.</p>
<div class="code scala highlight-text"><div class="highlight"><pre><span></span>import com.google.inject.assistedinject.Assisted
import javax.inject.Inject

class RealPaymentService @Inject()(
  @Assisted paymentQueue: PaymentQueue,
  notifier: Notifier
)
</pre></div>
</div>
<p>where “assisted” here means that injection will be <em>assisted</em> by having a user-supplied value provided for
the annotated field to use in constructing an instance of the object.</p>
<p>You would typically also create a “factory” which exposes a method that accepts the <cite>&#64;Assisted</cite> annotated field:</p>
<div class="code scala highlight-text"><div class="highlight"><pre><span></span>trait RealPaymentServiceFactory {
  def create(paymentQueue: PaymentQueue): RealPaymentService
}
</pre></div>
</div>
<p>Then bind this as an “assisted factory” in a <cite>TwitterModule</cite> and include the module in your server’s
list of modules.</p>
<div class="code scala highlight-text"><div class="highlight"><pre><span></span>import com.twitter.inject.TwitterModule

class PaymentServiceModule extends TwitterModule {

  override def configure(): Unit = {
    bindAssistedFactory[RealPaymentServiceFactory]()
  }
}
</pre></div>
</div>
<p>To obtain an instance you would get a reference to the factory from the injector and call the
factory method:</p>
<div class="code scala highlight-text"><div class="highlight"><pre><span></span>val factory = injector.instance[RealPaymentServiceFactory]
val paymentService: RealPaymentService = factory.create(new MyPaymentQueue)
</pre></div>
</div>
<p>For Java examples please see the <a class="reference external" href="https://github.com/google/guice/wiki/AssistedInject">Guice documentation</a>.</p>
</div>
<div class="section" id="field-injection-not-recommended">
<h3>Field Injection (not recommended)<a class="headerlink" href="#field-injection-not-recommended" title="Permalink to this headline">¶</a></h3>
<p>If you want to do field injection in a Scala class (again, not recommended), you would do so inside of the defined class on a mutable member of the class. Note that this introduces mutability into your class and is not something generally recommended.</p>
<div class="code scala highlight-text"><div class="highlight"><pre><span></span>import javax.inject.Inject

class LessIdealPaymentService {
  @Inject
  private var notifier: Notifier = _
}
</pre></div>
</div>
</div>
<div class="section" id="injecting-third-party-code">
<h3>Injecting third-party code<a class="headerlink" href="#injecting-third-party-code" title="Permalink to this headline">¶</a></h3>
<p>If you want to be able to inject a type that is not a class you own – meaning you cannot annotate the class or its constructor since it is not your code but you want to be able to inject an instance of the type, then prefer defining a <a class="reference external" href="./modules.html">Module</a> which can provide an (ideally immutable) instance of the class to the object graph.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>The Guice documentation recommends <a class="reference external" href="https://github.com/google/guice/wiki/KeepConstructorsHidden">keeping constructors hidden</a> for classes which are meant to be instantiated by the injector. If you prefer constructor injection to create immutable objects, the difference between manual instantiation and injector instantiation should only come down to scoping of the created instance, i.e., is it a Singleton (the same instance every time from the injector). Finatra takes the approach of the <cite>&#64;Inject</cite> annotation being metadata in that it signals that the class <em>can</em> be instantiated by the injector but it is not a requirement.</p>
<p class="last">We leave reducing the visibility of constructors to your discretion as a matter of what makes sense for your project or team.</p>
</div>
</div>
</div>
<div class="section" id="inject-direct-dependencies">
<h2>Inject direct dependencies<a class="headerlink" href="#inject-direct-dependencies" title="Permalink to this headline">¶</a></h2>
<p>Avoid injecting an object simply as a way to get another object. For instance do not inject a <cite>Customer</cite> simply to obtain an <cite>Account</cite>:</p>
<div class="code scala highlight-text"><div class="highlight"><pre><span></span>class Budget @Inject()(
  customer: Customer
) {
  val account: Account = customer.purchasingAccount
}
</pre></div>
</div>
<p>Instead, you should prefer to inject this dependency directly since this can make testing easier because your tests do not need to know anything about the <cite>Customer</cite> object. This is where defining a <a class="reference external" href="./modules.html">Module</a> is useful. Using an <cite>&#64;Provides</cite>-annotated method you can create a binding for <cite>Account</cite> which comes from a <cite>Customer</cite> binding:</p>
<div class="code scala highlight-text"><div class="highlight"><pre><span></span>class CustomersModule extends TwitterModule {

  @Provides
  def providePurchasingAccount(
    customer: Customer
  ): Account = {
    customer.purchasingAccount
  }
}
</pre></div>
</div>
<p>Injecting this binding makes the code simpler:</p>
<div class="code scala highlight-text"><div class="highlight"><pre><span></span>class Budget @Inject()(account: Account)
</pre></div>
</div>
</div>
<div class="section" id="avoid-cyclic-dependencies">
<h2>Avoid cyclic dependencies<a class="headerlink" href="#avoid-cyclic-dependencies" title="Permalink to this headline">¶</a></h2>
<p>This is good practice in general and cycles often reflect insufficiently granular decomposition. For instance, assume you have a <cite>Store</cite>, a <cite>Boss</cite>, and a <cite>Clerk</cite>.</p>
<div class="code scala highlight-text"><div class="highlight"><pre><span></span>class Store @Inject()(boss: Boss) {
  def incomingCustomer(customer: Customer): Unit = ???
  def nextCustomer: Customer = ???
}

class Boss @Inject()(clerk: Clerk)

class Clerk()
</pre></div>
</div>
<p>So far, so good. Constructing a <cite>Store</cite> constructs a new <cite>Boss</cite> which in turn constructs a new <cite>Clerk</cite>. However, to give the <cite>Clerk</cite> a <cite>Customer</cite> in order to make a sale, the <cite>Clerk</cite> needs a reference to the <cite>Store</cite> to get those customers:</p>
<div class="code scala highlight-text"><div class="highlight"><pre><span></span>class Store @Inject()(boss: Boss) {
  def incomingCustomer(customer: Customer): Unit = ???
  def nextCustomer: Customer = ???
}

class Boss @Inject()(clerk: Clerk)

class Clerk @Inject()(store: Store) {
  def doSale(): Unit = {
    val customer = store.nextCustomer
    ...
  }
}
</pre></div>
</div>
<p>which now leads to a cycle, <cite>Clerk</cite> -&gt; <cite>Store</cite> -&gt; <cite>Boss</cite> -&gt; <cite>Clerk</cite>.</p>
<div class="section" id="eliminate-the-cycle-preferred">
<h3>Eliminate the cycle (preferred)<a class="headerlink" href="#eliminate-the-cycle-preferred" title="Permalink to this headline">¶</a></h3>
<p>One way to eliminate such cycles is to extract the dependency case into a separate class. In the contrived example, we could introduce a way of representing a line of eager customers as a <cite>CustomerLine</cite> which can be injected into a <cite>Clerk</cite> or a <cite>Store</cite>.</p>
<div class="code scala highlight-text"><div class="highlight"><pre><span></span>class Store @Inject()(boss: Boss, customers: CustomerLine) {
  def incomingCustomer(customer: Customer): Unit = ???
  def nextCustomer: Customer = ???
}

class Clerk @Inject()(customers: CustomerLine) {
  def doSale(): Unit = {
    val customer = customers.nextCustomer
    ...
  }
}
</pre></div>
</div>
<p><cite>Store</cite> and <cite>Clerk</cite> now both depend on a <cite>CustomerLine</cite> (you should ensure that they use the same instance) and thus no longer a cycle in the graph.</p>
</div>
<div class="section" id="use-a-provider">
<h3>Use a Provider<a class="headerlink" href="#use-a-provider" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="https://github.com/google/guice/wiki/InjectingProviders">Injecting a Provider</a> allows you to inject a seam into the dependency graph. In this case, the <cite>Clerk</cite> still depends on a <cite>Store</cite> but the <cite>Clerk</cite> does not dereference the <cite>Store</cite> until needed by asking for it from the <cite>Provider[Store]</cite>:</p>
<div class="code scala highlight-text"><div class="highlight"><pre><span></span>class Clerk @Inject()(
  Provider[Store] storeProvider
) {
  def doSale(): Unit = {
    val customer = storeProvider.get.nextCustomer
  }
}
</pre></div>
</div>
<p>Note: you should ensure in this case that the <cite>Store</cite> is bound as a <cite>Singleton</cite> (otherwise the <cite>Provider.get</cite> will instantiate a new <cite>Store</cite> which ends up in the cycle).</p>
</div>
</div>
<div class="section" id="avoid-i-o-with-providers">
<h2>Avoid I/O with Providers<a class="headerlink" href="#avoid-i-o-with-providers" title="Permalink to this headline">¶</a></h2>
<p>As we saw in the above example, Providers can be a useful API but it lacks some semantics that you should be aware of:</p>
<ul class="simple">
<li>If you need to recover from specific failures the Provider API only returns a generic <cite>ProvisionException</cite>. You can <a class="reference external" href="https://google.github.io/guice/api-docs/latest/javadoc/com/google/inject/ProvisionException.html#getErrorMessages()">iterate through the causes</a> but you will not be able to catch the specific type. See <a class="reference external" href="https://github.com/google/guice/wiki/ThrowingProviders">ThrowingProviders</a> for a way to declare thrown exceptions from a <cite>Provider</cite>.</li>
<li>No support for timeout. Thus you can deadlock waiting on the <cite>Provider</cite> to be available with a call to <cite>Provider.get</cite>.</li>
<li>There is no retry for obtaining the instance from a Provider. If <cite>Provider.get</cite> is unavailable, multiple calls to <cite>get</cite> may simply throw multiple exceptions.</li>
</ul>
</div>
<div class="section" id="avoid-conditional-logic-in-modules">
<h2>Avoid conditional logic in modules<a class="headerlink" href="#avoid-conditional-logic-in-modules" title="Permalink to this headline">¶</a></h2>
<p>It can be tempting to create <a class="reference external" href="./modules.html">Modules</a> which have conditional logic and can be configured to operate differently for different environments. We strongly recommend avoiding this pattern and the framework provides utilities (including <a class="reference external" href="./flags.html">Flags</a>) to help in this regard.</p>
<p>Please avoid doing this:</p>
<div class="code scala highlight-text"><div class="highlight"><pre><span></span>// DO NOT DO THIS
class FooModule(fooServer: String) extends TwitterModule {
  override protected def configure(): Unit = {
    if (fooServer != null) {
      bind[String](Names.named(&quot;fooServer&quot;)).toInstance(fooServer)
      bind[FooService].to[RemoteService]
    } else {
      bind[FooService].to[InMemoryFooService]
    }
  }
}

// NOR THIS
class FooModule extends TwitterModule {
  val env = flag(&quot;env&quot;, &quot;remote&quot;, &quot;the environment&quot;)

  override protected def configure(): Unit = {
    if (env() == &quot;remote&quot;) {
      bind[String](Names.named(&quot;fooServer&quot;)).toInstance(fooServer)
      bind[FooService].to[RemoteService]
    } else {
      bind[FooService].to[InMemoryFooService]
    }
  }
}
</pre></div>
</div>
<p>Doing this can lead to situations where bindings are not exercised and thus not tested in a
<a class="reference external" href="../testing/startup_tests.html">StartupTest</a>, defeating its utility.</p>
<div class="admonition important">
<p class="first admonition-title">Important</p>
<p class="last">We <strong>strongly</strong> recommend that <em>only production code ever be deployed to production</em> and thus configuration which should change per environment be externalized via <a class="reference external" href="./flags.html">Flags</a> and logic that should differ per environment be encapsulated within <a class="reference external" href="../testing/override_modules.html">override modules</a> (that are not located with the production code – e.g., production code in <cite>src/main/scala</cite> and test code in <cite>src/test/scala</cite>).</p>
</div>
<p>For more information see the sections on <a class="reference external" href="./flags.html">Flags</a>, <a class="reference external" href="./modules.html">Modules</a>, and <a class="reference external" href="../testing/override_modules.html">Override Modules</a>.</p>
</div>
<div class="section" id="make-use-of-the-twittermodule-lifecycle">
<h2>Make use of the <cite>TwitterModule</cite> lifecycle<a class="headerlink" href="#make-use-of-the-twittermodule-lifecycle" title="Permalink to this headline">¶</a></h2>
<p>Finatra adds a lifecycle to Modules which is directly tied to the <a class="reference external" href="./lifecycle.html">server (or application) lifecycle</a> in which the module is used. This allows users to overcome some of the limitations of a standard <cite>AbstractModule</cite>.</p>
<p>The <a class="reference external" href="https://github.com/twitter/finatra/blob/f275df9ea4e00ea3690e63e72a5445bb2c98cea7/inject/inject-core/src/main/scala/com/twitter/inject/TwitterModuleLifecycle.scala#L9">c.t.inject.TwitterModuleLifecycle</a> defines several phases which allow users to setup and teardown or close <cite>Singleton</cite> scoped resources. Thus, you are able to bind closable resources with a defined way to release them.</p>
<div class="admonition important">
<p class="first admonition-title">Important</p>
<p class="last">Please note that the lifecycle is for <strong>Singleton</strong>-scoped resources and users should still avoid binding unscoped resources without ways to shutdown or close them.</p>
</div>
<p>See: Guice’s documentation on <a class="reference external" href="https://github.com/google/guice/wiki/ModulesShouldBeFastAndSideEffectFree">Modules should be fast and side-effect free</a> and <a class="reference external" href="https://github.com/google/guice/wiki/Avoid-Injecting-Closable-Resources">Avoid Injecting Closable Resources</a>.</p>
<p>For more information on Finatra Modules see the documentation <a class="reference external" href="./modules.html">here</a>.</p>
</div>
<div class="section" id="scala-to-java-type-conversions">
<h2>Scala to Java Type conversions<a class="headerlink" href="#scala-to-java-type-conversions" title="Permalink to this headline">¶</a></h2>
<p>Both the <cite>c.t.inject.TwitterModule</cite> and <cite>c.t.inject.Injector</cite> are Scala classes which support creation of a Guice <a class="reference external" href="https://google.github.io/guice/api-docs/latest/javadoc/index.html?com/google/inject/TypeLiteral.html">TypeLiteral</a> based on the given Type <cite>T</cite> parameter. A <a class="reference external" href="https://google.github.io/guice/api-docs/latest/javadoc/index.html?com/google/inject/TypeLiteral.html">TypeLiteral</a> is used to construct the binding <a class="reference external" href="https://google.github.io/guice/api-docs/latest/javadoc/index.html?com/google/inject/Key.html">Key</a> for storing the bound instance in the object graph. The framework uses the <a class="reference external" href="https://github.com/codingwell/scala-guice/">codingwell/scala-guice</a> library for producing a <a class="reference external" href="https://google.github.io/guice/api-docs/latest/javadoc/index.html?com/google/inject/TypeLiteral.html">TypeLiteral</a> from a <cite>T</cite>.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Binding or injector lookup by type <cite>T</cite> can produce different Guice <a class="reference external" href="https://google.github.io/guice/api-docs/latest/javadoc/index.html?com/google/inject/Key.html">Key</a> values as the constructed <a class="reference external" href="https://google.github.io/guice/api-docs/latest/javadoc/index.html?com/google/inject/TypeLiteral.html">TypeLiteral</a> may carry more type information than Guice would normally be able to obtain in Java.</p>
</div>
<p>Because of the use of the Scala <a class="reference external" href="https://www.scala-lang.org/api/current/scala-reflect/scala/reflect/api/Types$TypeApi.html">Types.TypeApi</a>, it is possible that a generated <a class="reference external" href="https://google.github.io/guice/api-docs/latest/javadoc/index.html?com/google/inject/TypeLiteral.html">TypeLiteral</a> from a parameterized type, e.g., <cite>F[T]</cite>, will be different than what Guice itself would produce since Guice is a Java library and can suffer from <a class="reference external" href="https://docs.oracle.com/javase/tutorial/java/generics/erasure.html">type erasure</a> when using reflection to convert a Scala type to a Java type.</p>
<p>Thus, if you manually bind a parameterized type in a <cite>c.t.inject.TwitterModule</cite> using <cite>bind[T]</cite> in the <cite>configure()</cite> method, you may not be able to <cite>&#64;Inject</cite> the type into another class since the Guice Java library may not be able to construct the same <a class="reference external" href="https://google.github.io/guice/api-docs/latest/javadoc/index.html?com/google/inject/TypeLiteral.html">TypeLiteral</a> in order to build the <a class="reference external" href="https://google.github.io/guice/api-docs/latest/javadoc/index.html?com/google/inject/Key.html">Key</a> to locate the binding in the Injector.</p>
<p>However, you will be able to locate the type manually from the <cite>c.t.inject.Injector</cite> via <cite>inject.instance[T]</cite> which will generate the same <a class="reference external" href="https://google.github.io/guice/api-docs/latest/javadoc/index.html?com/google/inject/TypeLiteral.html">TypeLiteral</a> and thus the same <a class="reference external" href="https://google.github.io/guice/api-docs/latest/javadoc/index.html?com/google/inject/Key.html">Key</a> as created when manually calling <cite>bind[T]</cite> in a <cite>c.t.inject.TwitterModule</cite>.</p>
<p>For example, if you provide an <cite>Option[String]</cite> in an <cite>&#64;Provides</cite>-annotated method in a Module, Guice will create a Key over a TypeLiteral of just <cite>scala.Option</cite>:</p>
<div class="code scala highlight-text"><div class="highlight"><pre><span></span>scala&gt; val module = new AbstractModule {
 |   override def configure(): Unit = {
 |     bind(classOf[Option[String]]).toInstance(Some(&quot;hello&quot;))
 |   }
 | }
module: com.google.inject.AbstractModule = $anon$1@2f3a3fec

scala&gt; val injector = Guice.createInjector(module)
injector: com.google.inject.Injector = Injector{bindings=[InstanceBinding{key=Key[type=scala.Option, annotation=[none]], source=$anon$1.configure(&lt;console&gt;:21), instance=Some(hello)}]}
</pre></div>
</div>
<p>However, using the <cite>c.t.inject.TwitterModule</cite> binding DSL would produce a <a class="reference external" href="https://google.github.io/guice/api-docs/latest/javadoc/index.html?com/google/inject/Key.html">Key</a> with a fully specified <a class="reference external" href="https://google.github.io/guice/api-docs/latest/javadoc/index.html?com/google/inject/TypeLiteral.html">TypeLiteral</a>:</p>
<div class="code scala highlight-text"><div class="highlight"><pre><span></span>scala&gt; val module = new AbstractModule with ScalaModule {
 |   override def configure(): Unit = {
 |     bind[Option[String]].toInstance(Some(&quot;hello&quot;))
 |   }
 | }
module: com.google.inject.AbstractModule with net.codingwell.scalaguice.ScalaModule = $anon$1@6ebbc06

scala&gt; val injector = Guice.createInjector(module)
injector: com.google.inject.Injector = Injector{bindings=[InstanceBinding{key=Key[type=scala.Option&lt;java.lang.String&gt;, annotation=[none]], source=$anon$1.configure(&lt;console&gt;:17), instance=Some(hello)}]}
</pre></div>
</div>
<p>This can also affect <cite>&#64;Inject</cite>-ing an instance of the type versus manually obtaining an instance from the injector.</p>
<p>A workaround for consistency is to introduce an unparameterized wrapper type over the parameterized type or
consistently use the Java methods for binding and lookup, e.g., <cite>&#64;Provides</cite>-annotated methods in Modules, and the <cite>Class[_]</cite>-based methods for binding and injector instance retrieval.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/finatra_logo.png" alt="Logo"/>
            </a></p><p>
  <a href="https://github.com/twitter/finatra">Finatra</a> is a Scala services framework built on top of <a href="https://twitter.github.io/twitter-server/">TwitterServer</a> and <a href="https://twitter.github.io/finagle/">Finagle</a>.
</p>

<h3>Useful Links</h3>
<ul>
  <li><a href="https://twitter.github.io/finatra/user-guide">User's&nbsp;Guide</a></li>
  <li><a href="https://finagle.github.io/blog/">Finagle&nbsp;Blog</a></li>
  <li><a href="https://github.com/twitter/finatra">Finatra&nbsp;on&nbsp;Github</a></li>
  <li><a href="https://github.com/twitter/finatra/issues">Github&nbsp;Issues</a></li>
</ul>
  <h3><a href="../../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Dependency Injection</a><ul>
<li><a class="reference internal" href="#what-is-this-doing">What Is This Doing?</a></li>
<li><a class="reference internal" href="#why-use-the-object-graph">Why Use The Object Graph?</a></li>
</ul>
</li>
<li><a class="reference internal" href="#dependency-injection-and-testing">Dependency Injection and Testing</a></li>
<li><a class="reference internal" href="#dependency-injection-best-practices">Dependency Injection Best Practices</a><ul>
<li><a class="reference internal" href="#use-constructor-injection">Use Constructor Injection</a><ul>
<li><a class="reference internal" href="#assistedinject">AssistedInject</a></li>
<li><a class="reference internal" href="#field-injection-not-recommended">Field Injection (not recommended)</a></li>
<li><a class="reference internal" href="#injecting-third-party-code">Injecting third-party code</a></li>
</ul>
</li>
<li><a class="reference internal" href="#inject-direct-dependencies">Inject direct dependencies</a></li>
<li><a class="reference internal" href="#avoid-cyclic-dependencies">Avoid cyclic dependencies</a><ul>
<li><a class="reference internal" href="#eliminate-the-cycle-preferred">Eliminate the cycle (preferred)</a></li>
<li><a class="reference internal" href="#use-a-provider">Use a Provider</a></li>
</ul>
</li>
<li><a class="reference internal" href="#avoid-i-o-with-providers">Avoid I/O with Providers</a></li>
<li><a class="reference internal" href="#avoid-conditional-logic-in-modules">Avoid conditional logic in modules</a></li>
<li><a class="reference internal" href="#make-use-of-the-twittermodule-lifecycle">Make use of the <cite>TwitterModule</cite> lifecycle</a></li>
<li><a class="reference internal" href="#scala-to-java-type-conversions">Scala to Java Type conversions</a></li>
</ul>
</li>
</ul>
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">User’s Guide</a><ul>
      <li>Previous: <a href="../index.html" title="previous chapter">User’s Guide</a></li>
      <li>Next: <a href="framework.html" title="next chapter">Understanding the Codebase</a></li>
  </ul></li>
  </ul></li>
</ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Search the contents of this site.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
  
    <div class="github-fork-ribbon-wrapper right fixed" style="width: 150px;height: 150px;position: fixed;overflow: hidden;top: 0;z-index: 9999;pointer-events: none;right: 0;"><div class="github-fork-ribbon" style="position: absolute;padding: 2px 0;background-color: #900;background-image: linear-gradient(to bottom, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.15));-webkit-box-shadow: 0 2px 3px 0 rgba(0, 0, 0, 0.5);-moz-box-shadow: 0 2px 3px 0 rgba(0, 0, 0, 0.5);box-shadow: 0 2px 3px 0 rgba(0, 0, 0, 0.5);z-index: 9999;pointer-events: auto;top: 42px;right: -43px;-webkit-transform: rotate(45deg);-moz-transform: rotate(45deg);-ms-transform: rotate(45deg);-o-transform: rotate(45deg);transform: rotate(45deg);"><a target="_blank" href="https://github.com/twitter/finatra" style="font: 700 13px &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;color: #fff;text-decoration: none;text-shadow: 0 -1px rgba(0, 0, 0, 0.5);text-align: center;width: 200px;line-height: 20px;display: inline-block;padding: 2px 0;border-width: 1px 0;border-style: dotted;border-color: rgba(255, 255, 255, 0.7);">Fork me on GitHub</a></div></div>
  

  <div class="footer">
    &copy; Copyright 2013-2020 Twitter, Inc.
    Created using <a href="http://sphinx.pocoo.org/">Sphinx</div>
  
  </body>
</html>