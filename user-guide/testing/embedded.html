<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Embedded Servers and Apps &#8212; Finatra 19.6.0 documentation</title>
    
    <link rel="stylesheet" href="../../_static/flasky.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '19.6.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="top" title="Finatra 19.6.0 documentation" href="../../index.html" />
    <link rel="up" title="User’s Guide" href="../index.html" />
    <link rel="next" title="Feature Tests" href="feature_tests.html" />
    <link rel="prev" title="Testing Features" href="index.html" />
   
  
  <link media="only screen and (max-device-width: 480px)" href="../../_static/small_flask.css" type= "text/css" rel="stylesheet" />
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-39101739-4', 'twitter.github.io');
    ga('send', 'pageview');

  </script>

  </head>
  <body role="document">
  
  

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="feature_tests.html" title="Feature Tests"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="index.html" title="Testing Features"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Finatra</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">User&#8217;s Guide</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="embedded-servers-and-apps">
<span id="embedded"></span><h1>Embedded Servers and Apps<a class="headerlink" href="#embedded-servers-and-apps" title="Permalink to this headline">¶</a></h1>
<p>Finatra provides a way to run an embedded version of your service or app running locally on ephemeral
ports. This allows you to run <em>actual</em> requests against an <em>actual</em> version of your server when testing.</p>
<p>The embedded utilities are also useful for testing and debugging your code when prototyping. If your
service or API makes calls to other services, instead of mocking out or overriding those dependencies
with dummy implementations you can always write a test using an Embedded version of your server which
talks to <em>real</em> downstream services (of course you&#8217;d never want to commit a test like this to your
source repository, especially if you run any type of <a class="reference external" href="https://en.wikipedia.org/wiki/Continuous_integration">continuous integration</a> system).
You&#8217;ll be able to run this test normally through the test runner of an IDE which would allow you to
easily set breakpoints and step-through code for debugging. As opposed to needing to build and run
your service locally and attach a remote debugger.</p>
<p>See:</p>
<ul class="simple">
<li><a class="reference external" href="https://github.com/twitter/finatra/blob/develop/inject/inject-app/src/test/scala/com/twitter/inject/app/EmbeddedApp.scala">c.t.inject.app.EmbeddedApp</a></li>
<li><a class="reference external" href="https://github.com/twitter/finatra/blob/develop/inject/inject-server/src/test/scala/com/twitter/inject/server/EmbeddedTwitterServer.scala">c.t.inject.server.EmbeddedTwitterServer</a></li>
<li><a class="reference external" href="https://github.com/twitter/finatra/blob/develop/http/src/test/scala/com/twitter/finatra/http/EmbeddedHttpServer.scala">c.t.finatra.http.EmbeddedHttpServer</a></li>
<li><a class="reference external" href="https://github.com/twitter/finatra/blob/develop/thrift/src/test/scala/com/twitter/finatra/thrift/EmbeddedThriftServer.scala">c.t.finatra.thrift.EmbeddedThriftServer</a></li>
</ul>
<img alt="../../_images/embedded.png" src="../../_images/embedded.png" />
<p>You&#8217;ll notice that this hierarchy generally follows the server trait hierarchy as <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/http/src/main/scala/com/twitter/finatra/http/HttpServer.scala"><cite>c.t.finatra.http.HttpServer</cite></a>
and <a class="reference external" href="https://github.com/twitter/twitter-server/blob/develop/src/main/scala/com/twitter/server/TwitterServer.scala"><cite>c.t.finatra.thrift.ThriftServer</cite></a> extend from <a class="reference external" href="https://github.com/twitter/twitter-server/blob/develop/src/main/scala/com/twitter/server/TwitterServer.scala"><cite>c.t.server.TwitterServer</cite></a> which extends from
<a class="reference external" href="https://github.com/twitter/util/blob/develop/util-app/src/main/scala/com/twitter/app/App.scala"><cite>c.t.app.App</cite></a>.</p>
<div class="section" id="testing-with-global-flags">
<h2>Testing With <cite>Global Flags</cite><a class="headerlink" href="#testing-with-global-flags" title="Permalink to this headline">¶</a></h2>
<p>The embedded servers and the embedded app allow for passing <a class="reference external" href="https://github.com/twitter/util">TwitterUtil</a> <a class="reference external" href="https://github.com/twitter/util/blob/1dd3e6228162c78498338b1c3aa11afe2f8cee22/util-app/src/main/scala/com/twitter/app/Flag.scala">Flags</a>
to the server under test via the <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/inject/inject-server/src/test/scala/com/twitter/inject/server/EmbeddedTwitterServer.scala#L130">flags</a>
constructor argument (a map of flag name to flag value) which is meant to mimic setting flag values
via the command line.</p>
<p>However it is <strong>not recommended</strong> that users set any <a class="reference external" href="https://github.com/twitter/util/blob/f2a05474ec41f34146d710bdc2a789efd6da9d21/util-app/src/main/scala/com/twitter/app/GlobalFlag.scala"><cite>GlobalFlag</cite></a> value in this manner. In normal
usage, the value of a <a class="reference external" href="https://github.com/twitter/util/blob/f2a05474ec41f34146d710bdc2a789efd6da9d21/util-app/src/main/scala/com/twitter/app/GlobalFlag.scala"><cite>GlobalFlag</cite></a> is <strong>only read once during the initialization of the JVM process</strong>.</p>
<p>A <a class="reference external" href="https://github.com/twitter/util/blob/f2a05474ec41f34146d710bdc2a789efd6da9d21/util-app/src/main/scala/com/twitter/app/GlobalFlag.scala"><cite>GlobalFlag</cite></a> can now be scoped for the execution of an embedded server by passing in a value via the
<a class="reference external" href="https://github.com/twitter/finatra/blob/develop/inject/inject-server/src/test/scala/com/twitter/inject/server/EmbeddedTwitterServer.scala#L142">globalFlags</a>
arg of an embedded server. For example,</p>
<div class="code scala highlight-text"><div class="highlight"><pre><span></span>import com.twitter.finatra.http.EmbeddedHttpServer
import com.twitter.finagle.http.Status
import com.twitter.inject.server.FeatureTest

class ExampleServerFeatureTest extends FeatureTest {
  override val server = new EmbeddedHttpServer(
    twitterServer = new ExampleServer,
    globalFlags = ListMap(com.foo.bar.someGlobalFlag -&gt; &quot;a value&quot;)
  )

  test(&quot;ExampleServer#perform feature&quot;) {
    // any read of the `com.foo.bar.someGlobalFlag` value within the server will be &quot;a value&quot;
    server.httpGet(
      path = &quot;/&quot;,
      andExpect = Status.Ok)

    ???
  }
}
</pre></div>
</div>
<p>If you wish to test with toggled values of a <a class="reference external" href="https://github.com/twitter/util/blob/f2a05474ec41f34146d710bdc2a789efd6da9d21/util-app/src/main/scala/com/twitter/app/GlobalFlag.scala"><cite>GlobalFlag</cite></a> for an embedded app or server, you can
still use <a class="reference external" href="https://twitter.github.io/util/docs/com/twitter/app/Flag.html#let[R](t:T)(f:=%3ER):R"><cite>Flag.let</cite></a> or <a class="reference external" href="https://twitter.github.io/util/docs/com/twitter/app/Flag.html#letClear[R](f:=%3ER):R"><cite>Flag.letClear</cite></a> in tests. Note that if an embedded server takes
<a class="reference external" href="https://github.com/twitter/finatra/blob/develop/inject/inject-server/src/test/scala/com/twitter/inject/server/EmbeddedTwitterServer.scala#L142">globalFlags</a>
arguments, they will take precedents over an outer <a class="reference external" href="https://twitter.github.io/util/docs/com/twitter/app/Flag.html#let[R](t:T)(f:=%3ER):R"><cite>Flag.let</cite></a>. It is recommended to test using
<a class="reference external" href="https://twitter.github.io/util/docs/com/twitter/app/Flag.html#let[R](t:T)(f:=%3ER):R"><cite>Flag.let</cite></a> or <a href="#id3"><span class="problematic" id="id4">|FlagLegClear|_</span></a> on a <a class="reference external" href="https://github.com/twitter/util/blob/f2a05474ec41f34146d710bdc2a789efd6da9d21/util-app/src/main/scala/com/twitter/app/GlobalFlag.scala"><cite>GlobalFlag</cite></a> in places where the global flag value is read once and not
treated as a runtime variable, otherwise behavior can be unexpected across thread boundaries.
For example,</p>
<div class="code scala highlight-text"><div class="highlight"><pre><span></span>import com.twitter.finatra.http.EmbeddedHttpServer
import com.twitter.finagle.http.Status
import com.twitter.inject.server.FeatureTest

class ExampleServerFeatureTest extends FeatureTest {
  override val server = new EmbeddedHttpServer(
    twitterServer = new ExampleServer,
    globalFlags = ListMap(com.foo.bar.someGlobalFlag -&gt; &quot;a value&quot;)
  )

  test(&quot;ExampleServer#perform feature&quot;) {

    com.foo.bar.someGlobalFlag.let(&quot;b value&quot;) {
      // any read of the `com.foo.bar.someGlobalFlag` value in this closure will be &quot;b value&quot;

      com.foo.bar.someGlobalFlag() should equal(&quot;b value&quot;)

      // except execution within the server will see &quot;a value&quot; due to `globalFlags` scope
      server.httpGet(
        path = &quot;/&quot;,
        andExpect = Status.Ok)

      ???
    }
  }
}
</pre></div>
</div>
<p>See the <a class="reference external" href="https://twitter.github.io/util/docs/com/twitter/app/Flag.html">scaladoc</a> for <cite>c.t.app.Flag</cite>
for more information on using <a class="reference external" href="https://twitter.github.io/util/docs/com/twitter/app/Flag.html#let[R](t:T)(f:=%3ER):R"><cite>Flag.let</cite></a> or <a class="reference external" href="https://twitter.github.io/util/docs/com/twitter/app/Flag.html#letClear[R](f:=%3ER):R"><cite>Flag.letClear</cite></a>.</p>
</div>
<div class="section" id="inmemorystatsreceiver">
<h2>InMemoryStatsReceiver<a class="headerlink" href="#inmemorystatsreceiver" title="Permalink to this headline">¶</a></h2>
<p>The <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/inject/inject-server/src/test/scala/com/twitter/inject/server/EmbeddedTwitterServer.scala"><cite>EmbeddedTwitterServer</cite></a> (and thus its subclasses: <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/http/src/test/scala/com/twitter/finatra/http/EmbeddedHttpServer.scala"><cite>EmbeddedHttpServer</cite></a> and <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/thrift/src/test/scala/com/twitter/finatra/thrift/EmbeddedThriftServer.scala"><cite>EmbeddedThriftServer</cite></a>)
binds an instance of the <a class="reference external" href="https://github.com/twitter/util/blob/develop/util-stats/src/main/scala/com/twitter/finagle/stats/InMemoryStatsReceiver.scala">com.twitter.finagle.stats.InMemoryStatsReceiver</a>
to the underlying server&#8217;s object graph (if the underlying server supports injection). This will
override any other bound implementation of a <a class="reference external" href="https://github.com/twitter/util/blob/develop/util-stats/src/main/scala/com/twitter/finagle/stats/StatsReceiver.scala">c.t.finagle.stats.StatsReceiver</a>
in the server&#8217;s object graph.</p>
<p>The <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/inject/inject-server/src/test/scala/com/twitter/inject/server/EmbeddedTwitterServer.scala"><cite>EmbeddedTwitterServer</cite></a> exposes the bound <a class="reference external" href="https://github.com/twitter/util/blob/develop/util-stats/src/main/scala/com/twitter/finagle/stats/StatsReceiver.scala">StatsReceiver</a>
along with helper methods for asserting <a class="reference external" href="https://github.com/twitter/finatra/blob/c6e4716f082c0c8790d06d9e1664aacbd0c3fede/inject/inject-server/src/test/scala/com/twitter/inject/server/EmbeddedTwitterServer.scala#L323">counter</a>,
<a class="reference external" href="https://github.com/twitter/finatra/blob/c6e4716f082c0c8790d06d9e1664aacbd0c3fede/inject/inject-server/src/test/scala/com/twitter/inject/server/EmbeddedTwitterServer.scala#L335">stat</a>,
and <a class="reference external" href="https://github.com/twitter/finatra/blob/c6e4716f082c0c8790d06d9e1664aacbd0c3fede/inject/inject-server/src/test/scala/com/twitter/inject/server/EmbeddedTwitterServer.scala#L343">gauge</a>
values, such that you can expect behavior against the underlying server&#8217;s recorded stats in tests.</p>
<p><a class="reference external" href="#feature_tests">Feature Tests</a> also <a class="reference external" href="https://github.com/twitter/finatra/blob/c6e4716f082c0c8790d06d9e1664aacbd0c3fede/inject/inject-server/src/test/scala/com/twitter/inject/server/FeatureTestMixin.scala#L50">print all recorded stats</a>
to stdout after each test by default.</p>
<p>See: <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/inject-thrift-client-http-mapper/src/test/scala/com/twitter/finatra/multiserver/test/MultiServerFeatureTest.scala">c.t.finatra.multiserver.test.MultiServerFeatureTest</a>
for an example usage.</p>
</div>
<div class="section" id="more-information">
<h2>More Information<a class="headerlink" href="#more-information" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><a class="reference internal" href="index.html"><span class="doc">Testing Features</span></a></li>
<li><a class="reference internal" href="feature_tests.html"><span class="doc">Feature Tests</span></a></li>
<li><a class="reference internal" href="integration_tests.html"><span class="doc">Integration Tests</span></a></li>
<li><a class="reference internal" href="startup_tests.html"><span class="doc">Startup Tests</span></a></li>
<li><a class="reference internal" href="mixins.html"><span class="doc">Test Mixins</span></a></li>
<li><a class="reference internal" href="mocks.html"><span class="doc">Working with Mocks</span></a></li>
<li><a class="reference internal" href="override_modules.html"><span class="doc">Override Modules</span></a></li>
<li><a class="reference internal" href="bind_dsl.html"><span class="doc">Explicit Binding with #bind[T]</span></a></li>
</ul>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/finatra_logo.png" alt="Logo"/>
            </a></p><p>
  <a href="https://github.com/twitter/finatra">Finatra</a> is a Scala services framework built on top of <a href="https://twitter.github.io/twitter-server/">TwitterServer</a> and <a href="https://twitter.github.io/finagle/">Finagle</a>.
</p>

<h3>Useful Links</h3>
<ul>
  <li><a href="https://twitter.github.io/finatra/user-guide">User's&nbsp;Guide</a></li>
  <li><a href="https://finagle.github.io/blog/">Finagle&nbsp;Blog</a></li>
  <li><a href="https://github.com/twitter/finatra">Finatra&nbsp;on&nbsp;Github</a></li>
  <li><a href="https://github.com/twitter/finatra/issues">Github&nbsp;Issues</a></li>
</ul>
  <h3><a href="../../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Embedded Servers and Apps</a><ul>
<li><a class="reference internal" href="#testing-with-global-flags">Testing With <cite>Global Flags</cite></a></li>
<li><a class="reference internal" href="#inmemorystatsreceiver">InMemoryStatsReceiver</a></li>
<li><a class="reference internal" href="#more-information">More Information</a></li>
</ul>
</li>
</ul>
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">User&#8217;s Guide</a><ul>
      <li>Previous: <a href="index.html" title="previous chapter">Testing Features</a></li>
      <li>Next: <a href="feature_tests.html" title="next chapter">Feature Tests</a></li>
  </ul></li>
  </ul></li>
</ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Search the contents of this site.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
  
    <div class="github-fork-ribbon-wrapper right fixed" style="width: 150px;height: 150px;position: fixed;overflow: hidden;top: 0;z-index: 9999;pointer-events: none;right: 0;"><div class="github-fork-ribbon" style="position: absolute;padding: 2px 0;background-color: #900;background-image: linear-gradient(to bottom, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.15));-webkit-box-shadow: 0 2px 3px 0 rgba(0, 0, 0, 0.5);-moz-box-shadow: 0 2px 3px 0 rgba(0, 0, 0, 0.5);box-shadow: 0 2px 3px 0 rgba(0, 0, 0, 0.5);z-index: 9999;pointer-events: auto;top: 42px;right: -43px;-webkit-transform: rotate(45deg);-moz-transform: rotate(45deg);-ms-transform: rotate(45deg);-o-transform: rotate(45deg);transform: rotate(45deg);"><a target="_blank" href="https://github.com/twitter/finatra" style="font: 700 13px &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;color: #fff;text-decoration: none;text-shadow: 0 -1px rgba(0, 0, 0, 0.5);text-align: center;width: 200px;line-height: 20px;display: inline-block;padding: 2px 0;border-width: 1px 0;border-style: dotted;border-color: rgba(255, 255, 255, 0.7);">Fork me on GitHub</a></div></div>
  

  <div class="footer">
    &copy; Copyright 2013-2019 Twitter, Inc.
    Created using <a href="http://sphinx.pocoo.org/">Sphinx</div>
  
  </body>
</html>